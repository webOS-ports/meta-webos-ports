From 3d44c91a868ac966cac46c390bc96465b32e3b2a Mon Sep 17 00:00:00 2001
From: Herman van Hazendonk <github.com@herrie.org>
Date: Wed, 11 Apr 2018 14:25:11 +0200
Subject: [PATCH 1/2] configurator: Add service file for systemd & script

In order to get rid of webos-initscripts, add the required files to the components.

Signed-off-by: Herman van Hazendonk <github.com@herrie.org>
---
 CMakeLists.txt                              |  4 +++
 files/scripts/configurator-db8.sh.in        | 24 ++++++++++++++++++
 files/systemd/configurator-activity.service | 27 +++++++++++++++++++++
 files/systemd/configurator-db8.service      | 27 +++++++++++++++++++++
 4 files changed, 82 insertions(+)
 create mode 100644 files/scripts/configurator-db8.sh.in
 create mode 100644 files/systemd/configurator-activity.service
 create mode 100644 files/systemd/configurator-db8.service

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 60e64d4..1054287 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -66,3 +66,7 @@ target_link_libraries(configurator
 webos_configure_header_files(src)
 webos_build_daemon(NAME configurator LAUNCH files/launch)
 webos_build_system_bus_files()
+
+# install the script file
+webos_configure_source_files(CONFIG-DB8 files/scripts/configurator-db8.sh)
+install(PROGRAMS ${CONFIG-DB8} DESTINATION ${WEBOS_INSTALL_SBINDIR})
diff --git a/files/scripts/configurator-db8.sh.in b/files/scripts/configurator-db8.sh.in
new file mode 100644
index 0000000..84f61ac
--- /dev/null
+++ b/files/scripts/configurator-db8.sh.in
@@ -0,0 +1,24 @@
+#!/bin/sh
+# Copyright (c) 2017-2018 LG Electronics, Inc.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+# http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# SPDX-License-Identifier: Apache-2.0
+
+# first pass we register file cache and dbkinds
+logger -s "Configuring dbkinds & filecache"
+/usr/bin/luna-send -n 1 palm://com.palm.configurator/run '{"types":["dbkinds","filecache"]}'
+
+# This has to happen *after* the kinds are created.
+logger -s "Configuring dbpermissions"
+/usr/bin/luna-send -n 1 palm://com.palm.configurator/run '{"types":["dbpermissions"]}'
diff --git a/files/systemd/configurator-activity.service b/files/systemd/configurator-activity.service
new file mode 100644
index 0000000..29c41a5
--- /dev/null
+++ b/files/systemd/configurator-activity.service
@@ -0,0 +1,27 @@
+# Copyright (c) 2017-2018 LG Electronics, Inc.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+# http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# SPDX-License-Identifier: Apache-2.0
+
+[Unit]
+Description=webos - "%n"
+Requires=ls-hubd.service configurator-db8.service
+After=ls-hubd.service configurator-db8.service activitymanager.service
+BindsTo=activitymanager.service
+
+[Service]
+Type=oneshot
+ExecStartPre=/usr/bin/logger -s "Configuring activities asynchronously"
+ExecStart=/usr/bin/luna-send -n 1 -f palm://com.palm.configurator/run '{"types":["activities"]}'
+RemainAfterExit=yes
diff --git a/files/systemd/configurator-db8.service b/files/systemd/configurator-db8.service
new file mode 100644
index 0000000..96ac67f
--- /dev/null
+++ b/files/systemd/configurator-db8.service
@@ -0,0 +1,27 @@
+# Copyright (c) 2017-2018 LG Electronics, Inc.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+# http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# SPDX-License-Identifier: Apache-2.0
+
+# Creates the database schema for webos Applications.
+
+[Unit]
+Description=webos - "%n"
+Requires=ls-hubd.service db8.service
+After=ls-hubd.service db8.service
+
+[Service]
+Type=oneshot
+ExecStart=/usr/sbin/configurator-db8.sh
+RemainAfterExit=yes
-- 
2.37.3.windows.1


From 6c8a2069e4e0f46e48f0a16c400f4a458cca832d Mon Sep 17 00:00:00 2001
From: Herman van Hazendonk <github.com@herrie.org>
Date: Sun, 27 Feb 2022 17:38:25 +0100
Subject: [PATCH] Add sam.sh script from webos-initscripts and install it

Fixes: Feb 27 11:49:34 qemux86-64 systemd[645]: sam.service: Failed to locate executable /lib/systemd/system/scripts/sam.sh: No such file or directory

Signed-off-by: Herman van Hazendonk <github.com@herrie.org>

---
 CMakeLists.txt          |  6 ++++++
 files/scripts/sam.sh.in | 23 +++++++++++++++++++++++
 2 files changed, 29 insertions(+)
 create mode 100644 files/scripts/sam.sh.in

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9ffa77a..30d6b7d 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -115,6 +115,12 @@ install(TARGETS ${CMAKE_PROJECT_NAME} DESTINATION ${WEBOS_INSTALL_SBINDIR})
 # sam conf files
 configure_file(${CMAKE_CURRENT_SOURCE_DIR}/files/conf/sam-conf.json.in ${CMAKE_CURRENT_BINARY_DIR}/files/conf/sam-conf.json)
 
+webos_configure_source_files(lib_in_scripts
+    files/scripts/sam.sh
+)
+
+install(PROGRAMS ${lib_in_scripts} DESTINATION ${WEBOS_INSTALL_BASE_LIBDIR}/systemd/system/scripts)
+
 file(GLOB_RECURSE SAM_CONF_FILES ${CMAKE_CURRENT_BINARY_DIR}/files/conf/*)
 install(FILES ${SAM_CONF_FILES} DESTINATION ${WEBOS_INSTALL_WEBOS_SYSCONFDIR})
 
diff --git a/files/scripts/sam.sh.in b/files/scripts/sam.sh.in
new file mode 100644
index 0000000..3d5e1c3
--- /dev/null
+++ b/files/scripts/sam.sh.in
@@ -0,0 +1,23 @@
+#!/bin/sh
+# Copyright (c) 2017-2018 LG Electronics, Inc.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+# http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# SPDX-License-Identifier: Apache-2.0
+
+DIR="/tmp"
+if [ -e $DIR/sam-respawned ] ; then
+    KEY="\"\@system_native_app\""
+    echo `pgrep -lf $KEY -P 1`
+    exec `pkill -sigkill -f $KEY -P 1`
+fi

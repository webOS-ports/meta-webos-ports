From 71c5a51c8f0b1175789b1f7b812b0680839c6934 Mon Sep 17 00:00:00 2001
From: Herman van Hazendonk <github.com@herrie.org>
Date: Wed, 11 Apr 2018 14:40:38 +0200
Subject: [PATCH 1/4] settingsservice: Add service files for systemd & script

In order to get rid of webos-initscripts, add the required files to the components.

Signed-off-by: Herman van Hazendonk <github.com@herrie.org>
---
 CMakeLists.txt                                |  3 ++
 files/scripts/settings-service.sh.in          | 22 +++++++++++++
 .../systemd/settings-service-recovery.service | 33 +++++++++++++++++++
 files/systemd/settings-service.service        | 30 +++++++++++++++++
 4 files changed, 88 insertions(+)
 create mode 100644 files/scripts/settings-service.sh.in
 create mode 100644 files/systemd/settings-service-recovery.service
 create mode 100644 files/systemd/settings-service.service

diff --git a/CMakeLists.txt b/CMakeLists.txt
index a66f245..6b52910 100755
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -104,6 +104,9 @@ install(FILES ${DB8_PERM_FILES} DESTINATION ${WEBOS_INSTALL_WEBOS_SYSCONFDIR}/se
 install(FILES ${DB8_KIND_FILES} DESTINATION ${WEBOS_INSTALL_WEBOS_SYSCONFDIR}/db/kinds)
 install(FILES ${DB8_PERM_FILES} DESTINATION ${WEBOS_INSTALL_WEBOS_SYSCONFDIR}/db/permissions)
 
+webos_configure_source_files(SETTINGSERVICE files/scripts/settings-service.sh)
+install(PROGRAMS ${SETTINGSERVICE} DESTINATION ${WEBOS_INSTALL_SBINDIR})
+
 string(TOUPPER ${CMAKE_BUILD_TYPE} _build_type)
 if (_build_type STREQUAL DEBUG)
   webos_add_compiler_flags(ALL -Werror)
diff --git a/files/scripts/settings-service.sh.in b/files/scripts/settings-service.sh.in
new file mode 100644
index 0000000..9b5e765
--- /dev/null
+++ b/files/scripts/settings-service.sh.in
@@ -0,0 +1,22 @@
+#!/bin/sh
+# Copyright (c) 2017-2018 LG Electronics, Inc.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+# http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# SPDX-License-Identifier: Apache-2.0
+
+if [ -f /usr/bin/saveEnvironmentCondition ]
+then
+    /usr/bin/saveEnvironmentCondition
+fi
+exec /usr/sbin/SettingsService
diff --git a/files/systemd/settings-service-recovery.service b/files/systemd/settings-service-recovery.service
new file mode 100644
index 0000000..e8a2f74
--- /dev/null
+++ b/files/systemd/settings-service-recovery.service
@@ -0,0 +1,33 @@
+# Copyright (c) 2017-2018 LG Electronics, Inc.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+# http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# SPDX-License-Identifier: Apache-2.0
+
+# Settings Service Recovery for Platform settings
+# This upstart script only create /tmp/settingsservice_ready file
+# ONLY if it receives settingsservice-ready event.
+
+[Unit]
+Description=webos - "%n"
+Requires=settings-service.service
+After=settings-service.service
+
+# TODO
+#start on instant-boot-done
+
+[Service]
+Type=oneshot
+ExecStart=/bin/sh -euc 'echo "settingsservice_ready" > /tmp/settingsservice_ready'
+ExecStart=/bin/sh -euc 'if [ -f /usr/bin/recover_hdr_psm.sh ]; then /usr/bin/recover_hdr_psm.sh || true; fi;'
+RemainAfterExit=no
diff --git a/files/systemd/settings-service.service b/files/systemd/settings-service.service
new file mode 100644
index 0000000..e46df88
--- /dev/null
+++ b/files/systemd/settings-service.service
@@ -0,0 +1,30 @@
+# Copyright (c) 2017-2018 LG Electronics, Inc.
+#
+# Licensed under the Apache License, Version 2.0 (the "License");
+# you may not use this file except in compliance with the License.
+# You may obtain a copy of the License at
+#
+# http://www.apache.org/licenses/LICENSE-2.0
+#
+# Unless required by applicable law or agreed to in writing, software
+# distributed under the License is distributed on an "AS IS" BASIS,
+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+# See the License for the specific language governing permissions and
+# limitations under the License.
+#
+# SPDX-License-Identifier: Apache-2.0
+
+# Settings Service for Platform settings
+
+[Unit]
+Description=webos - "%n"
+Requires=ls-hubd.service db8.service
+After=ls-hubd.service db8.service
+
+[Service]
+Type=notify
+OOMScoreAdjust=-900
+EnvironmentFile=-/var/systemd/system/env/settings-service.env
+ExecStart=/usr/sbin/settings-service.sh
+#ExecStartPost=/usr/bin/check_settings_db_health.py &
+Restart=on-failure
-- 
2.37.3.windows.1


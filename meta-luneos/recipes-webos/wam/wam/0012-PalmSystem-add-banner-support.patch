From dab1bc44555d3db2a41ec9ffceea04a11fd20ec5 Mon Sep 17 00:00:00 2001
From: Christophe Chapuis <chris.chapuis@gmail.com>
Date: Sun, 5 Mar 2023 18:19:40 +0000
Subject: [PATCH 12/12] PalmSystem: add banner support

Signed-off-by: Christophe Chapuis <chris.chapuis@gmail.com>
---
 src/platform/webengine/palm_system_blink.cc | 52 +++++++++++++++++++++
 src/platform/webengine/palm_system_blink.h  |  9 +++-
 2 files changed, 60 insertions(+), 1 deletion(-)

diff --git a/src/platform/webengine/palm_system_blink.cc b/src/platform/webengine/palm_system_blink.cc
index 0c70a72..23005e1 100644
--- a/src/platform/webengine/palm_system_blink.cc
+++ b/src/platform/webengine/palm_system_blink.cc
@@ -178,6 +178,22 @@ std::string PalmSystemBlink::HandleBrowserControlMessage(
       std::string file_str = util::ReadFile(path);
       return file_str;
     }
+  } else if (command == "addBannerMessage") {
+    std::string _msg           = arguments.size()>=1 ? arguments[0] : "";
+    std::string _params        = arguments.size()>=2 ? arguments[1] : "";
+    std::string _icon          = arguments.size()>=3 ? arguments[2] : "";
+    std::string _soundClass    = arguments.size()>=4 ? arguments[3] : "";
+    std::string _soundFile     = arguments.size()>=5 ? arguments[4] : "";
+    std::string _duration      = arguments.size()>=6 ? arguments[5] : "0";
+    std::string _doNotSuppress = arguments.size()>=7 ? arguments[6] : "false";
+
+    return std::to_string(AddBannerMessage(_msg, _params, _icon, _soundClass, _soundFile, _duration, _doNotSuppress));
+  } else if (command == "removeBannerMessage") {
+    if (arguments.size() == 1) {
+      RemoveBannerMessage(arguments[0]);
+    }
+  } else if (command == "clearBannerMessages") {
+    ClearBannerMessages();
   }
 
   return std::string();
@@ -229,6 +245,42 @@ double PalmSystemBlink::DevicePixelRatio() {
   return static_cast<WebPageBlink*>(app_->Page())->DevicePixelRatio();
 }
 
+// banner management
+int PalmSystemBlink::AddBannerMessage(const std::string &msgTitle, const std::string &launchParams,
+                                      const std::string &msgIconUrl, const std::string &soundClass,
+                                      const std::string &msgSoundFile, const std::string &duration,
+                                      const std::string &doNotSuppress) {
+  std::string create_params = "{";
+
+  create_params += "\"title\" : \"" + msgTitle + "\", ";
+  create_params += "\"launchParams\" : \"" + launchParams + "\", ";
+  create_params += "\"iconUrl\" : \"" + msgIconUrl + "\", ";
+  create_params += "\"soundClass\" : \"" + soundClass + "\", ";
+  create_params += "\"soundFile\" : \"" + msgSoundFile + "\", ";
+  create_params += "\"duration\" : \"" + duration + "\", ";
+  create_params += "\"doNotSuppress\" : \"" + doNotSuppress + "\", ";
+  create_params += "\"expireTimeout\" : \"0\" }";
+
+  app_->ServiceCall("luna://org.webosports.notifications/create", create_params, app_->AppId());
+
+  static int currentNotifId = 0; // just a workaround, but could very well fail...
+  return currentNotifId++;
+  // return QString("%1").arg(response.value("id").toInt());                    
+}
+void PalmSystemBlink::RemoveBannerMessage(std::string id) {
+  std::string remove_params = R"(
+    {"id" : ")" + id + R"("}
+  )";
+
+  app_->ServiceCall("luna://org.webosports.notifications/close", remove_params, app_->AppId());
+}
+void PalmSystemBlink::ClearBannerMessages() {
+    
+  std::string clear_params = "{}";
+      
+  app_->ServiceCall("luna://org.webosports.notifications/closeAll", clear_params, app_->AppId());
+}
+
 Json::Value PalmSystemBlink::Initialize() {
   initialized_ = true;
 
diff --git a/src/platform/webengine/palm_system_blink.h b/src/platform/webengine/palm_system_blink.h
index dd9899d..30e4427 100644
--- a/src/platform/webengine/palm_system_blink.h
+++ b/src/platform/webengine/palm_system_blink.h
@@ -42,7 +42,7 @@ class PalmSystemBlink : public PalmSystemWebOS {
   virtual double DevicePixelRatio();
   void ResetInitialized() { initialized_ = false; }
   bool IsInitialized() { return initialized_; }
-
+  
  protected:
   // PalmSystemWebOS
   Json::Value Initialize();
@@ -52,6 +52,13 @@ class PalmSystemBlink : public PalmSystemWebOS {
   virtual std::string TrustLevel() const;
   virtual void OnCloseNotify(const std::string& params);
 
+  int AddBannerMessage(const std::string &msgTitle, const std::string &launchParams,
+                       const std::string &msgIconUrl, const std::string &soundClass,
+                       const std::string &msgSoundFile, const std::string &duration,
+                       const std::string &doNotSuppress);
+  void RemoveBannerMessage(std::string id);
+  void ClearBannerMessages();
+
  private:
   bool initialized_ = false;
 };
-- 
2.41.0.windows.3


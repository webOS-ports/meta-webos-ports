From 63187d149a6afc440422fab7c173e49114b825b6 Mon Sep 17 00:00:00 2001
From: Simon Busch <morphis@gravedo.de>
Date: Tue, 12 Nov 2013 16:25:45 +0100
Subject: [PATCH 7/8] Do not get blocked on an unmapped buffer

Upstream-Status: Inappropiate [upstream applied a different version]
---
 src/compositor/wayland_wrapper/qwlsurface.cpp | 10 ++++++++--
 1 file changed, 8 insertions(+), 2 deletions(-)

diff --git a/src/compositor/wayland_wrapper/qwlsurface.cpp b/src/compositor/wayland_wrapper/qwlsurface.cpp
index 7574175..946d174 100644
--- a/src/compositor/wayland_wrapper/qwlsurface.cpp
+++ b/src/compositor/wayland_wrapper/qwlsurface.cpp
@@ -317,8 +317,14 @@ bool Surface::advanceBufferQueue()
     //do we have another buffer in the queue
     //and does it have a valid damage rect
 
-    if (m_backBuffer && !m_backBuffer->isDisplayed())
-        return true;
+    if (m_backBuffer && !m_backBuffer->isDisplayed()) {
+        if (m_backBuffer->waylandBufferHandle()) {
+            return true;
+        } else {
+            m_backBuffer->disown();
+        }
+    }
+
     if (m_bufferQueue.size()) {
         QSize size;
         if (m_backBuffer && m_backBuffer->waylandBufferHandle()) {
-- 
1.8.1.2


From 1d81406045cde4ff78fea2346113da7fc62bb3f5 Mon Sep 17 00:00:00 2001
From: Simon Busch <morphis@gravedo.de>
Date: Thu, 2 Jan 2014 15:37:30 +0100
Subject: [PATCH] foundations: rework error to string conversion to not cause
 an endless error message
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Simon Busch <morphis@gravedo.de>
Signed-off-by: Achim KÃ¶nigs <garfonso@tratschtante.de>
---
 foundations/javascript/structure/err.js | 6 +-----
 foundations/node_module.js              | 2 +-
 2 files changed, 2 insertions(+), 6 deletions(-)

diff --git a/foundations/javascript/structure/err.js b/foundations/javascript/structure/err.js
index 02cb517..81e8179 100644
--- a/foundations/javascript/structure/err.js
+++ b/foundations/javascript/structure/err.js
@@ -34,11 +34,7 @@ var Err = exports.Err =
 
     _toFullString: function(e)
     {
-        if (e.stack)
-        {
-            return e.stack;
-        }
-        else if (e.message)
+        if (e.message)
         {
             return "Error: " + e.message;
         }
diff --git a/foundations/node_module.js b/foundations/node_module.js
index 3ec1554..cddc3c4 100644
--- a/foundations/node_module.js
+++ b/foundations/node_module.js
@@ -1 +1 @@
-var MojoLoader=require("mojoloader.js");exports.Control={};exports.Data={};exports.Comms={};exports.IO={};exports.Assert={};exports.Localization={};var PalmBus;exports.onLoad=function(){exports.Comms.AjaxCall.setup();exports.Comms.PalmCall.setup()}; var EnvironmentUtils=exports.EnvironmentUtils={runtime:function(){return"undefined"!==typeof root&&root.process&&root.process.version?"node":"undefined"!==typeof webOS?"triton":"browser"},isBrowser:function(){return"browser"===this.runtime()},isTriton:function(){return"triton"===this.runtime()},isNode:function(){return"node"===this.runtime()}},Class=exports.Class={create:function(a,b){function c(){this.initialize.apply(this,arguments)}b?b.__proto__=a.prototype:(b=a||{},b.__proto__=this._base);b.constructor= c;"undefined"!==typeof inBuiltinEnv&&inBuiltinEnv?setPrototype(c,b):c.prototype=b;return c},_base:{initialize:function(){},$super:function(a){var b=this;if(a._super)return function(){return a._super.apply(b,arguments)};var c=a.name;if(!c)throw Err.create(-1,"No method name:"+a);for(var d=this.__proto__;d;d=d.__proto__)if(d[c]===a){for(d=d.__proto__;d;d=d.__proto__){var f=d[c];if(f)return a._super=f,function(){return f.apply(b,arguments)}}break}throw Err.create(-1,"Method not found: "+c);}}},Err=exports.Err= {create:function(a,b,c){b=Error(b);b.errorCode=void 0!==a?a:-1;b.innerError=c;b.toString=this._toString;return b},_toString:function(){return Err._toFullString(this)+(this.innerError?"; inner"+Err._toFullString(this.innerError):"")},_toFullString:function(a){return a.stack?a.stack:a.message?"Error: "+a.message:"Error: "+JSON.stringify(a)}},ArrayUtils=exports.ArrayUtils={clear:function(a){return a.splice(0,a.length)}},StringUtils=exports.StringUtils={parseQueryString:function(a,b){var c=a.indexOf("?"), d=a.indexOf("#"),d=-1<d?d:a.length;a=a.substring(-1<c?c+1:0,d);for(var c={},d=a.split(b||"&"),f=d.length,e=0;e<f;++e){var g=d[e].split("="),h=decodeURIComponent(g.shift()),k=void 0;0<g.length&&(k=1<g.length?g.join("="):g[0],k=decodeURIComponent(k));h&&(c.hasOwnProperty(h)?(g=c[h],"array"===ObjectUtils.type(g)?g.push(k):g=[g,k],c[h]=g):c[h]=k)}return c},camelize:function(a){return a.replace(/-(.?)/g,function(a,c){return c?c.toUpperCase():""})},startsWith:function(a,b){return 0===a.indexOf(b)},endsWith:function(a, b){var c=a.length-b.length;return 0<=c&&a.indexOf(b,c)===c},isBlank:function(a){return/^\s*$/.test(a)},includes:function(a,b){return-1!==a.indexOf(b)},entityRegex:/[<>&]/g,unentityRegex:/(&lt;)|(&gt;)|(&amp;)/g,escapeCharacterMap:{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},unescapeCharacterMap:{"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&apos;":"'"},escapeCommon:function(a,b,c){return a.replace(b,function(a){return c[a]})},escapeHTML:function(a){return StringUtils.escapeCommon(a, StringUtils.entityRegex,StringUtils.escapeCharacterMap)},unescapeHTML:function(a){return StringUtils.escapeCommon(a,StringUtils.unentityRegex,StringUtils.unescapeCharacterMap)},stripTags:function(a){return a.replace(/<\/?[^>]+>/gi,"")},stripScripts:function(a){return a.replace(/<script[^>]*>[\S\s]*?<\/script>/img,"")}},ObjectUtils=exports.ObjectUtils={type:function(a){return null===a?"null":void 0===a?"undefined":"number"==typeof a?"number":"string"==typeof a?"string":!0===a||!1===a?"boolean":"[object Array]"== Object.prototype.toString.call(a)?"array":"function"==typeof a?"function":"object"},clone:function(a,b,c){return this._clone(a,b||{},"$",c||function(a,b){return a})},_clone:function(a,b,c,d){switch(this.type(a)){case "null":return d(null,c);case "undefined":return d(void 0,c);case "number":case "boolean":case "string":return d(a,c);case "array":return d(this._cloneArray(a,b,c,d),c);case "function":return d(b.ignoreFunctions?void 0:a,c);default:return d(this._cloneObject(a,b,c,d),c)}},_cloneObject:function(a, b,c,d){var f={},e=0,g=0,h;for(h in a)if(!b.ignoreUnderscoreProperties||"_"!=h.charAt(0)){var k=this._clone(a[h],b,c+"."+h,d);void 0!==k&&(f[h]=k,valid=1,e++);g++}"__partial"in a&&e++;g!=e&&(b.ignorePartialObjects&&!0!==a.__partial)&&(e=0);return!b.ignoreEmptyObjects||0<e?f:void 0},_cloneArray:function(a,b,c,d){for(var f=[],e=a.length,g=0;g<e;g++){var h=this._clone(a[g],b,c+"["+g+"]",d);void 0===h&&b.ignoreEmptyArrays||f.push(h)}return 0<f.length||!b.ignoreEmptyArrays?f:void 0},toQueryString:function(a){var b, c=[];for(b in a)if(a.hasOwnProperty(b)){var d=a[b],f=ObjectUtils.type(d),e=encodeURIComponent(b);switch(f){case "function":break;case "null":case "undefined":c.push(e);break;case "number":case "string":case "boolean":c.push(e+"="+encodeURIComponent(d));break;case "array":for(var f=d.length,g=0;g<f;++g)c.push(e+"="+encodeURIComponent(d[g]));break;case "object":break;default:throw Error("Can't convert unknown object type \""+f+'" to a query string');}}return c.join("&")}},Model=exports.Model={_token:1, _allscenes:{controller:{}},update:function(a,b,c,d){return this._update(a,b,c,d,!1)},delay:function(){var a=this;return{update:function(b,c,d,f){a._update(b,c,d,f,!0)},finish:function(b){a._sendPending(b);a._sendPending(a._allscenes)}}},create:function(a,b){this._notifyListeners({type:"create",model:b,diff:{},who:a},b,!1)},remove:function(a,b){this._notifyListeners({type:"remove",model:b,diff:this.merge({},b).old,who:a},b,!1)},merge:function(a,b,c){var d=!1,f={};if(b)for(var e in b)if("_"!=e.charAt(0)){var g= b[e];if(!Object.isFunction(g)){var h=a[e];if(null===h||void 0===h||null===g||void 0===g||"boolean"==typeof g||"number"==typeof g||Object.isString(g)||Object.isArray(g)){if(h!=g||c)f[e]=h,a[e]=g,d=!0}else g=this.merge(h,g,c),g.modified&&(f[e]=g.old,d=!0)}}return{modified:d,old:f}},setParent:function(a,b){a._webos$foundations$model$parent=b},addListener:function(a,b,c){b._webos$foundations$model$listeners||(b._webos$foundations$model$listeners={});a||(a=this._allscenes);a._webos$foundations$model$pending|| this._setupScene(a);a._webos$foundations$model$count++;var d=b._webos$foundations$model$listeners[a._webos$foundations$model$token];d||(d={who:a,pending:null,call:[]},b._webos$foundations$model$listeners[a._webos$foundations$model$token]=d);d.call.push(c)},removeListener:function(a,b,c){a||(a=this._allscenes);if(b._webos$foundations$model$listeners&&a._webos$foundations$model$token){if(b=b._webos$foundations$model$listeners[a._webos$foundations$model$token])if(c)for(var d=0;d<b.call.length;d++){if(b.call[d]=== c){b.call.splice(d,1);a._webos$foundations$model$count--;break}}else a._webos$foundations$model$count=0,b.call=[];0==a._webos$foundations$model$count&&this._cleanupScene(a)}},_update:function(a,b,c,d,f){void 0===c&&void 0===d&&(d=!0);c=this.merge(b,c,d);(d||c.modified)&&this._notifyListeners({type:"update",model:b,diff:c.old,who:a},b,f);return c.modified},_notifyListeners:function(a,b,c){var d=b._webos$foundations$model$listeners;if(d)for(var f in d)if("toJSON"!=f){var e=d[f];if(e.call){var g=e.who.controller; if(c||g&&g.isActive&&!g.isActive()&&a.who!=e.who){g=e.pending;g||(g={},e.pending=g);var h=a.model._webos$foundations$model$token,k=g[h];if(k){"remove"==a.type&&(k.type="remove");for(l in a.diff)k.diff[l]=a.diff[l];a.who!=k.who&&(k.who=null)}else{var k={},l;for(l in a)k[l]=a[l];k.diff={};for(l in a.diff)k.diff[l]=a.diff[l];g[h]=k;e.who._webos$foundations$model$pending.push(e)}}else for(g=0;g<e.call.length;g++)e.call[g](a)}}b._webos$foundations$model$parent&&this._notifyListeners(a,b._webos$foundations$model$parent, !1)},_sendPending:function(a){var b=a._webos$foundations$model$pending;if(b){a._webos$foundations$model$pending=[];a=b.length;for(var c=0;c<a;c++){var d=b[c],f=d.pending;d.pending=void 0;for(var e in f)d.call(f[e])}}},_setupScene:function(a){a._webos$foundations$model$token=this._token++;a._webos$foundations$model$pending=[];a._webos$foundations$model$count=0;if(a.controller.sceneElement){if(!this._aboutToActivateBound){var b=this;this._aboutToActivateBound=function(a){b._sendPending(a.target._webos$foundations$scene)}}a.controller.sceneElement._webos$foundations$scene= a;a.controller.sceneElement.addEventListener(Mojo.Event.aboutToActivate,this._aboutToActivateBound)}},_cleanupScene:function(a){a.controller.sceneElement&&(a.controller.sceneElement._webos$foundations$scene=void 0,a.controller.sceneElement.removeEventListener(Mojo.Event.aboutToActivate,this._aboutToActivateBound));a._webos$foundations$model$pending=void 0;a._webos$foundations$model$token=void 0;a._webos$foundations$model$count=void 0}}; function Future(a){this._insidefuture=-1;this._then=[];this._result={result:a,exception:void 0,isset:0<arguments.length,wasread:!1,cancelled:!1}}Future.prototype.now=function(a,b,c){return this._result.cancelled?this:this._docall(!0,a,b,c)};Future.prototype.then=function(a,b,c){return this._result.cancelled?this:this._docall(!1,a,b,c)}; Future.prototype.whilst=function(a,b,c,d){"function"===typeof a?(d=c,c=b,b=a,a=null):Assert.requireObject(a,"Future.whilst(): scope must be an object, was #{type}",{type:typeof a});Assert.requireFunction(b,"Future.whilst(): conditionfunc must be a function, was #{type}",{type:typeof b});Assert.requireFunction(c,"Future.whilst(): func must be a function, was #{type}",{type:typeof c});void 0!==d&&Assert.requireFunction(d,"Future.whilst(): errorfunc must be a function, was #{type}",{type:typeof d}); return this.then(this,function e(){this.getResult();b.call(a,this)?null!==a?this.now(a,c,d).then(this,e):this.now(c,d).then(this,e):this.result=this.result})};Future.prototype.immediate=function(a){this._result={result:a,exception:void 0,isset:!0,cancelled:!1,wasread:!1};return this};Future.prototype.cancel=function(){this._result.isset=!1;this._result.cancelled=!0;this._then=[]}; Future.prototype.status=function(){var a=this._result;return a.isset?a.exception?"exception":"result":a.cancelled?"cancelled":"none"};Future.prototype.onError=function(a){this._errorfunc=a}; Future.prototype._docall=function(a,b,c,d){var f;"function"===typeof b&&(d=c,c=b,b=null);d||(d=this._errorfunc);if(a){this._insidefuture=0;try{f=c.call(b,this),void 0!==f&&(f&&"function"===typeof f.then?this.nest(f):this.setResult(f))}catch(e){if(this._logexception(e),this._result={result:void 0,exception:e,isset:!1,cancelled:!1,wasread:!1},d)try{d.call(b,this)}catch(g){this._logexception(g)}else this._result.isset=!0}this._insidefuture=-1;0<this._then.length&&this._maybeDispatch()}else if(-1===this._insidefuture){if("[object Array]"=== Object.prototype.toString.call(c))for(a=c.length,f=0;f<a;f++)this._then.push({f:c[f],e:d,c:b});else this._then.push({f:c,e:d,c:b});this._maybeDispatch()}else if("[object Array]"===Object.prototype.toString.call(c))for(a=c.length,f=0;f<a;f++)this._then.splice(this._insidefuture++,0,{f:c[f],e:d,c:b});else this._then.splice(this._insidefuture++,0,{f:c,e:d,c:b});return this}; Future.prototype.callback=function(a,b){if("function"===typeof a)b=a,a=void 0;else if(!b)throw Error("Must define function");return Queue.current.wrap(this,function(){this._insidefuture=0;try{var c=b.apply(a,arguments);void 0!==c&&(c&&"function"===typeof c.then?this.nest(c):this.setResult(c))}catch(d){this._logexception(d),this._result={result:void 0,exception:d,isset:!0,cancelled:!1,wasread:!1}}this._insidefuture=-1;0<this._then.length&&this._maybeDispatch()})}; Future.prototype.nest=function(a){Assert.requireObject(a,"Future.nest() expects to be passed a Future, was of type #{type}",{type:typeof a});Assert.requireObject(a._result,"Future.nest() expects to be passed a Future");a._result.isset?(this._result=a._result,0<this._then.length&&this._maybeDispatch()):a.then(this,function(){try{this.result=a.result}catch(b){this.exception=b}});return this}; Future.prototype._maybeDispatch=function(){if(-1===this._insidefuture){for(;0<this._then.length&&this._result.isset;){this._insidefuture=0;var a=this._then.shift();try{this._result.isset=!1;var b;b=a.e&&this._result.exception?a.e.call(a.c,this):a.f.call(a.c,this);void 0!==b&&(b&&"function"===typeof b.then?this.nest(b):this.setResult(b));!this._result.wasread&&this._result.exception&&(this._result.isset=!0)}catch(c){if(this._logexception(c),this._result={result:void 0,exception:c,isset:!1,cancelled:!1, wasread:!1},a.e)try{a.e.call(a.c,this)}catch(d){this._logexception(d)}else this._result.isset=!0}}this._insidefuture=-1}};Future.prototype._logexception=function(a){console.error(a.stack||a)};Future.prototype.getResult=function(){return this.result};Future.prototype.setResult=function(a){this.result=a};Future.prototype.getException=function(){return this.exception};Future.prototype.setException=function(a){this.exception=a}; Future.prototype.__defineGetter__("result",function(){this._result.wasread=!0;if(this._result.exception)throw this._result.exception;return this._result.result});Future.prototype.__defineSetter__("result",function(a){if(!this._result.cancelled){if(this._result.exception&&!this._result.wasread)throw this._result.wasread=!0,this._result.exception;this._result={result:a,exception:void 0,isset:!0,cancelled:!1,wasread:!1};0<this._then.length&&this._maybeDispatch()}}); Future.prototype.__defineGetter__("exception",function(){this._result.wasread=!0;return this._result.exception});Future.prototype.__defineSetter__("exception",function(a){this._result={result:void 0,exception:a,isset:!0,cancelled:!1,wasread:!1};0<this._then.length&&this._maybeDispatch()});exports.Control.Future=Future; function FSM(a,b){this._context=b||a;this._states=a;this._state="__uninitialized";var c=this;this._context.go=function(a){c.go(a)};this._context.event=function(){return c.event.apply(c,arguments)};this._states.__uninitialized={};setTimeout(function(){c.go("__start")},0)}exports.Control.FSM=FSM;FSM.prototype.currentState=function(){return this._state}; FSM.prototype.go=function(a){for(;this._state!=a;){console.log("state "+this._state+" -> change to -> "+a);if(!a||!this._states[a]){console.log("Non-existstant state "+a);break}var b=this._states[this._state];b&&(b.__exit&&b.__exit.call(this._context),(b=b["__to_"+a])&&b.call(this._context));var b=this._states[a],c=b["__from_"+this._state];this._state=a;c&&c.call(this._context);a=b.__enter&&b.__enter.call(this._context)||this._state}}; FSM.prototype.event=function(a){console.log("state "+this._state+" -> event "+a);var b=this._states[this._state][a];b||(b=this._states[this._state].__any);if(b){try{var c=b.apply(this._context,Array.prototype.slice.call(arguments,1));c&&this.go(c)}catch(d){if(console.log(d.stack),b=this._states[this._state].__exception)try{(c=b.call(this._context,d))&&this.go(c)}catch(f){console.log(f.stack)}}return!0}return!1}; var mapReduce=exports.Control.mapReduce=function(a,b){return(new Future).now(function(c){function d(a){return(new Future).immediate(a)}function f(a){for(var b=new Future,c=0;c<a.length;c++)if(a[c].exception)return b.exception=a[c].exception,b;return b.immediate(a)}for(var e=a.map||d,g=a.reduce||f,h=b?b.length:0,k=h+1,l=[],m=0;m<h;m++)e(b[m]).then(b[m],function(a){var b={item:this};try{b.result=a.result}catch(d){b.exception=d}l.push(b);--k||c.nest(g(l))});--k||c.nest(g(l))})}; function _SubQ(a,b){this._queue=a;this._idx=b;this._list=[]}_SubQ.prototype.defer=function(a,b){this._list.push({scope:a,func:b,args:2>=arguments.length?void 0:Array.prototype.slice.call(arguments,2)});this._queue._dispatch(this._idx)};_SubQ.prototype.wrap=function(a,b){var c=this;return function(){c._list.push({scope:a,func:b,args:arguments});c._queue._dispatch(c._idx)}};_SubQ.prototype._next=function(){return this._list.shift()}; var Queue={_qs:[],_start:0,_current:void 0,_normal:1,q:function(a){void 0===a&&(a=this._normal);this._qs[a]||(this._qs[a]=new _SubQ(this,a));return this._qs[a]},defer:function(){var a=this.current;a.defer.apply(a,arguments)},_dispatch:function(a){if(this._running)a<this._start&&(this._start=a);else{this._start=a;var b=this;this._running=setTimeout(function d(){for(;b._start<b._qs.length;){var a=b._qs[b._start];if(a&&(a=a._next())){b._current=b._start;try{a.func.apply(a.scope,a.args)}catch(e){console.error(e.stack|| e)}b._current=void 0;continue}b._start++;if(b._start>b._normal&&b._start<b._qs.length){b._running=setTimeout(d,0);return}}b._running=void 0},0)}}};Queue.__defineGetter__("high",function(){return this.q(0)});Queue.__defineGetter__("normal",function(){return this.q(this._normal)});Queue.__defineGetter__("low",function(){return this.q(2)});Queue.__defineGetter__("current",function(){return this.q(this._current)});exports.Control.Queue=Queue; function Activity(a,b,c){this._trace("initialize",arguments);this._activity={name:a,description:b};this._activity.type=c?{background:!0}:{foreground:!0};this._refcount=1;this._subscription=this._owner=void 0;this.lastEvent=Activity.Event.start;this.serial=void 0;this.name=a} Activity.prototype={_service:"palm://com.palm.activitymanager/",_log:!1,_trace:function(a,b){if(this._log){for(var c="activity.js -> Activity."+a+"(",d=!0,f=0;f<b.length;f++)d?d=!1:c+=", ",c+=b[f];console.log(c+")")}},create:function(){this._trace("create",arguments);if(this._activityId)throw Err.create(-1,"Cannot create an activity if one has already been created");return this._create(!1)},start:function(a){this._trace("start",arguments);return this._activityId?PalmCall.call(this._service,"start", {activityId:this._activityId}):this._create(!0)},_create:function(a){this._trace("_create",arguments);return(new Future).now(this,function(b){this._subscription=PalmCall.call(this._service,"create",{activity:this._activity,start:a,replace:this._replace,subscribe:void 0===this._activity.callback}).then(this,function(a){this._activityId=a.result.activityId;this._owner=!0;a=a.result;b.result=a;this._monitor();a.event&&this._updateState(a.event)})})},adopt:function(a){this._trace("adopt",arguments);if(this._subscription)throw Err.create(-1, "Cannot adopt an activity if one has already been created");return(new Future).now(this,function(b){this.name="ActivityManager activity"+a;this._activityId=a;var c={activityId:this._activityId,subscribe:!0};this.serial&&(c.serial=this.serial);this._subscription=PalmCall.call(this._service,"adopt",c).then(this,function(a){if(a.result.adopted||a.result.event&&"orphan"===a.result.event)this._owner=!0;b.result=a.result;this._monitor()},function(a){b.setException(a.exception)})})},monitor:function(a){this._trace("monitor", arguments);return this._subscription?(console.warn("Shouldn't call monitor() when already subscribed."),new Future(this.lastEvent)):(new Future).now(this,function(b){this.name="Monitored activityID"+a;this._activityId=a;this._subscription=PalmCall.call(this._service,"monitor",{activityId:this._activityId,subscribe:!0}).then(this,function(a){b.result=a.result;this._monitor()},function(a){b.setException(a.exception)})})},complete:function(a){this._trace("complete",[this.name]);this._refcount=0;if(this._owner){var b= {activityId:this._activityId};a&&(b.restart=!0);this.serial&&(b.serial=this.serial);return PalmCall.call(this._service,"complete",b).then(this,function(a){void 0!==this._subscription&&(this._trace("unsubscribe(owned)",[]),PalmCall.cancel(this._subscription),this._subscription=void 0);a.result=a.result})}a&&console.error("Tried to complete&restart an activity we don't own - "+this._activityId);void 0!==this._subscription&&(this._trace("unsubscribe(not owned)",[]),PalmCall.cancel(this._subscription), this._subscription=void 0)},cancel:function(){this._trace("cancel",arguments);this._refcount=0;return PalmCall.call(this._service,"cancel",{activityId:this._activityId})},setTrigger:function(a,b,c){this._trace("setTrigger",arguments);this._activity.trigger={method:b,key:a,params:c};return this},setScheduleInterval:function(a,b){this._trace("setScheduleInterval",arguments);this._activity.schedule={interval:a,within:b};return this},setScheduleTime:function(a,b,c){this._trace("setScheduleTime",arguments); this._activity.schedule={start:a,end:b,within:c};return this},setRequirements:function(a){this._trace("setRequirements",arguments);this._activity.requirements=a;return this},setCallback:function(a,b){this._trace("setCallback",arguments);this._activity.callback={method:a,params:b};return this},setUserInitiated:function(a){this._trace("setUserInitiated",arguments);this._activity.type.userInitiated=a;return this},setExplicit:function(a){this._trace("setExplicit",arguments);this._activity.type.explicit= a;return this},setPersist:function(a){this._trace("setPersist",arguments);this._activity.type.persist=a;return this},setReplace:function(a){this._trace("setReplace",arguments);this._replace=a;return this},setPower:function(a){this._trace("setPower",arguments);this._activity.type.power=a;return this},setPowerDebounce:function(a){this._trace("setPowerDebounce",arguments);this._activity.type.powerDebounce=a;return this},setMetadata:function(a){this._trace("setMetadata",arguments);this._activity.metadata= a;return this},onEvent:function(a){this._trace("onEvent",arguments);if(this._eventCallback)throw Err.create(-1,"Only supports one callback");this._eventCallback=a},_monitor:function(){this._trace("_monitor",arguments);this._subscription?this._subscription.then(this,function b(c){this._trace("update ",[JSON.stringify(c.result)]);try{var d=c.result;this._subscription&&(this._subscription.then(this,b),this._updateState(d.event))}catch(f){console.error("Activity monitoring failed: activityId="+this._activityId+ ", activity="+JSON.stringify(this._activity)),console.error("exception was: "+f.stack)}}):console.warn("Foundations.activity: _monitor with no subscription active - probably completed already")},_updateState:function(a){this._trace("_updateState",[a]);this.lastEvent=a;if(a==Activity.Event.orphan)this._owner=!0;else if(a==Activity.Event.adopted)this._owner=!1;else if(a==Activity.Event.stop||a==Activity.Event.cancel||a==Activity.Event.complete)this._trace("_updateStatus: cancelling subscription",[]), PalmCall.cancel(this._subscription),this._subscription=void 0;this._eventCallback&&a&&this._eventCallback(a)}};Activity.Event={start:"start",stop:"stop",pause:"pause",cancel:"cancel",orphan:"orphan",adopted:"adopted",focused:"focused",unfocused:"unfocused",running:"running",yield:"yield",complete:"complete"};exports.Control.Activity=Activity; var DB=exports.Data.DB={get:function(a){return 0===a.length?new Future({returnValue:!0,results:[]}):this.execute("get",{ids:a})},put:function(a){return 0===a.length?new Future({returnValue:!0,results:[]}):this.execute("put",{objects:a})},find:function(a,b,c){return this.execute("find",{query:a,watch:b,count:c})},del:function(a,b){var c;if("[object Array]"==Object.prototype.toString.call(a)){if(0===a.length)return new Future({returnValue:!0,results:[]});c={ids:a}}else c={query:a,purge:!!b};return this.execute("del", c)},merge:function(a,b){var c;if("[object Array]"==Object.prototype.toString.call(a)){if(0===a.length)return new Future({returnValue:!0,results:[]});c={objects:a}}else c={query:a,props:b};return this.execute("merge",c)},reserveIds:function(a){return 0===a?new Future({returnValue:!0,ids:[]}):this.execute("reserveIds",{count:a})},putKind:function(a,b,c){return this.execute("putKind",{id:a,owner:b,indexes:c})},delKind:function(a){return this.execute("delKind",{id:a})},execute:function(a,b){return this.temp? PalmCall.call("palm://com.palm.tempdb/",a,b):PalmCall.call("palm://com.palm.db/",a,b)}},tempDBFactory=function(){this.temp=!0};tempDBFactory.prototype=DB;var TempDB=exports.Data.TempDB=new tempDBFactory;function TypedownDB(a,b,c,d){this._kind=a;this._sortKey=b;this._wordKeys=c;this._limit=d&&d.limit||50;this._trim=d&&d.trim||this._limit;this._style=d&&d.style||"words"}TypedownDB.prototype.__proto__=DB; TypedownDB.prototype.putKind=function(a,b,c){if(a&&a!=this._kind)throw Error("Attemping to putKind incompatible kind: found ",a+", requires "+this._kind);c.push({props:[{name:"typedown"}]});DB.putKind(this._kind,b,c)};TypedownDB.prototype.put=function(a){for(var b=a.length,c=0;c<b;c++)this._addTypedown(a[c]);return DB.put(a)};TypedownDB.prototype.merge=function(a,b){if("[object Array]"==Object.prototype.toString.call(a))for(var c=a.length,d=0;d<c;d++)this._addTypedown(a[d]);return DB.merge(a,b)}; TypedownDB.prototype.find=function(a,b,c){a=a||{};if(a.from&&a.from!=this._kind)throw Error("Attemping to query incompatible kind: found ",a.from+", requires "+this._kind);if(a.orderBy&&a.orderBy!=this._sortKey)throw Error("Attemping to orderBy incompatible key: found ",a.orderBy+", requires "+this._sortKey);a.from=this._kind;a.orderBy=this._sortKey;return DB.find(a,b,c)}; TypedownDB.prototype.search=function(a){a=this._cleanWords(a);return DB.find({from:this._kind,where:[{prop:"typedown",op:"%",val:a}],limit:this._limit}).then(this,function(a){var c=this._sortKey,d=a.result;d.sort(function(a,b){a=a[c]+a._id;b=b[c]+b._id;return a<b?-1:a==b?0:1});for(var f="",e=[],g=d.length,h=this._trim,k=0;k<g;k++){var l=d[k],m=l._id;if(m!=f){e.push(l);if(0>=--h)break;f=m}}a.result=e})}; TypedownDB.prototype._addTypedown=function(a){if(a._kind&&a._kind!=this._kind)throw Error("Attempting to put incompatible kind: found ",a._kind+", requires "+this._kind);a._kind=this._kind;for(var b=[],c=this._wordKeys.length,d=0;d<c;d++){var f=a[this._wordKeys[d]];if(f)switch(this._style){default:this._addWords(b,f);break;case "letters":this._addLetters(b,f)}}b.length&&(a.typedown=b)};TypedownDB.prototype._cleanWords=function(a){return a.replace(/[.!?,()-]/," ").replace(/\s+/," ").toLowerCase()}; TypedownDB.prototype._addWords=function(a,b){for(b=this._cleanWords(b);;){a.push(b);var c=b.indexOf(" ");if(-1==c)break;b=b.slice(c+1)}return a};TypedownDB.prototype._addLetters=function(a,b){for(b=this._cleanWords(b);0<b.length;)" "!=b.charAt(0)&&a.push(b),b=b.substring(1);return a}; var urlModule,httpModule,bufferModule,AjaxCall={ajaxCTimeout:null,ajaxCTimeoutValue:6E4,get:function(a,b){return this.call(AjaxCall.RequestMethod.GET,a,void 0,b)},head:function(a,b){return this.call(AjaxCall.RequestMethod.HEAD,a,void 0,b)},post:function(a,b,c){return this.call(AjaxCall.RequestMethod.POST,a,b,c)},_callMojo:function(a,b,c,d){return(new Future).now(this,function(f){d=d||{};a=a.toUpperCase();c&&a===AjaxCall.RequestMethod.GET&&(b=b+"?"+c,c=void 0);var e=new XMLHttpRequest;e.open(a,b); if(d.headers)for(var g in d.headers)d.headers.hasOwnProperty(g)&&e.setRequestHeader(g,d.headers[g]);e.onreadystatechange=f.callback(function(){if(4===e.readyState&&!e._complete)if(e._complete=!0,200<=e.status&&300>e.status){try{e.responseJSON=JSON.parse(e.responseText)}catch(a){}f.result=e}else throw Err.create(e.status,e.statusText);});e.send(c);f._ajax=e})},_cancelMojo:function(a){a._ajax.abort()},_callTriton:function(a,b,c,d){return(new Future).now(this,function(f){d=d||{};a=a.toUpperCase();c&& a!==AjaxCall.RequestMethod.POST&&(b=b.match("\\?")?b+"&"+c:b+"?"+c,c=void 0);var e=new webOS.Curl(b);d.headers&&e.setHeaders(d.headers);e.setOption(webOS.Curl.SSL_VERIFYPEER,0);e.setOption(webOS.Curl.SSL_VERIFYHOST,0);e.setOption(webOS.Curl.FOLLOWLOCATION,10);d.nocompression?e.setOption(webOS.Curl.ENCODING,"identity"):e.setOption(webOS.Curl.ENCODING,"");d.verbose&&e.setOption(webOS.Curl.VERBOSE,1);d.onRead&&(e.onread=d.onRead);var g={},h="";e.onheader=function(a){var b=a.indexOf(": ");if(-1!==b){var c= a.substring(0,b),b=a.substring(b+2,a.length-1);g[c]?("array"!=ObjectUtils.type(g[c])&&(g[c]=[g[c]]),g[c].push(b)):g[c]=b;h+=a;if(d.onHeader)try{d.onHeader(c,b)}catch(f){console.log("onHeader error: "+f)}}};switch(a){case AjaxCall.RequestMethod.POST:d.customRequest&&e.setOption(webOS.Curl.CUSTOMREQUEST,d.customRequest);e.post(c,f.callback(this,function(a){f._complete=!0;var b={responseText:a,getResponseHeader:function(a){return g[a]},getAllResponseHeaders:function(a){return h}};try{b.responseJSON= JSON.parse(a)}catch(c){}try{b.status=e.getInfo(webOS.Curl.CURLINFO_RESPONSE_CODE)}catch(d){}f.result=b}),f.callback(this,function(a,b){f._complete=!0;throw Err.create(a,b);}));break;case AjaxCall.RequestMethod.HEAD:e.setOption(webOS.Curl.NOBODY,1);e.setOption(webOS.Curl.HEADER,1);d.customRequest&&e.setOption(webOS.Curl.CUSTOMREQUEST,d.customRequest);e.get(f.callback(this,function(a){f._complete=!0;a={responseText:a,getResponseHeader:function(a){return g[a]},getAllResponseHeaders:function(a){return h}}; try{a.status=e.getInfo(webOS.Curl.CURLINFO_RESPONSE_CODE)}catch(b){}f.result=a}),f.callback(this,function(a,b){f._complete=!0;throw Err.create(a,b);}));break;default:d.customRequest&&e.setOption(webOS.Curl.CUSTOMREQUEST,d.customRequest),e.get(f.callback(this,function(a){f._complete=!0;var b={responseText:a,getResponseHeader:function(a){return g[a]},getAllResponseHeaders:function(a){return h}};try{b.responseJSON=JSON.parse(a)}catch(c){}try{b.status=e.getInfo(webOS.Curl.CURLINFO_RESPONSE_CODE)}catch(d){}f.result= b}),f.callback(this,function(a,b){f._complete=!0;throw Err.create(a,b);}))}f._handle=e;var k=this;f.getResponseStream=function(){return k._getResponseStream(f)}})},_foundations_io:void 0,_getResponseStream:function(a){this._foundations_io||(this._foundations_io=MojoLoader.require({name:"foundations.io",version:"1.0"})["foundations.io"]);return new this._foundations_io.AjaxStream(a._handle)},_cancelTriton:function(a){a._handle.abort()},_callNode:function(a,b,c,d){return(new Future).now(this,function(f){d= d||{};a=a.toUpperCase();c&&a!==AjaxCall.RequestMethod.POST&&(b=b.match("\\?")?b+"&"+c:b+"?"+c,c=void 0);d.customRequest&&(a=d.customRequest,a=a.toUpperCase());var e=urlModule.parse(b),g="https:"===e.protocol,h=parseInt(e.port,10)||(g?443:80),h=httpModule.createClient(h,e.host,g);h.addListener("error",function(a){f.exception=Err.create(a.errno,"httpClient error "+a.message)});var k={};k.host=e.host;k["Accept-Encoding"]="identity";g="ascii"===d.bodyEncoding?"ascii":"utf8";k["Content-Length"]="ascii"=== g?c&&c.length||0:c&&bufferModule.Buffer.byteLength(c)||0;k.Accept="*/*";k["Content-Type"]="application/x-www-form-urlencoded";k.Date=(new Date).toUTCString();Object.keys(d.headers||{}).forEach(function(a){k[a]=d.headers[a]});var l=e.pathname||"/";e.search&&(l+=e.search);var m={responseText:""},e=h.request(a,l,k),n=this;e.addListener("error",function(a){n.clearAjaxCTimeout();f.exception=Err.create(a.errno,"httpRequest error "+a.message)});e.addListener("response",function(a){function b(){n.clearAjaxCTimeout(); if(!c){c=!0;try{m.responseJSON=JSON.parse(m.responseText)}catch(a){}f.result=m}}f._response=a;m.status=a.statusCode;m.getResponseHeader=function(b){b=b.toLowerCase();return"set-cookie"===b?a.headers["set-cookie"].join(", "):a.headers[b]};m.getAllResponseHeaders=function(b){if(!m.allHeaders){b=[];for(var c in a.headers)a.headers.hasOwnProperty(c)&&b.push(""+c+": "+a.headers[c]);m.allHeaders=b.join("\r\n")}return m.allHeaders};if(d.onResponse&&"function"===typeof d.onResponse)d.onResponse(a.statusCode, a.headers);a.addListener("data",function(a){m.responseText+=a;if(d.onData&&"function"===typeof d.onData)d.onData(a)});a.addListener("error",function(a){n.clearAjaxCTimeout();f.exception=Err.create(a.errno,"httpResponse error "+a.message)});var c=!1;a.addListener("end",b);a.addListener("close",b)});this.clearAjaxCTimeout();this.ajaxCTimeout=setTimeout(function(){f.exception=Err.create(504,"Timeout received from ajaxCall ");try{console.log("Ajax call timeout hit. Canceling the call."),n.clearAjaxCTimeout(), AjaxCall.cancel(f)}catch(a){}},this.ajaxCTimeoutValue);e.end(c,g)})},_cancelNode:function(a){a._response&&(a._response.removeAllListeners(),a._response.connection.destroy(),delete a._response)},setup:function(){EnvironmentUtils.isBrowser()?(AjaxCall.call=AjaxCall._callMojo,AjaxCall.cancel=AjaxCall._cancelMojo):EnvironmentUtils.isTriton()?(AjaxCall.call=AjaxCall._callTriton,AjaxCall.cancel=AjaxCall._cancelTriton):(urlModule=require("url"),httpModule=require("http"),bufferModule=require("buffer"),AjaxCall.call= AjaxCall._callNode,AjaxCall.cancel=AjaxCall._cancelNode)},setCallTimeout:function(a){Assert.requireNumber(a,"AjaxCall.setCallTimeout: timeout parameter must be a number, was #{type}",{type:typeof a});this.ajaxCTimeoutValue=a},clearAjaxCTimeout:function(){try{this.ajaxCTimeout&&(clearTimeout(this.ajaxCTimeout),this.ajaxCTimeout=null)}catch(a){console.log("AjaxCall exception on clear timeout"+a)}},RequestMethod:{}};AjaxCall.RequestMethod.POST="POST";AjaxCall.RequestMethod.GET="GET"; AjaxCall.RequestMethod.HEAD="HEAD";exports.Comms.AjaxCall=AjaxCall; var PalmCall=exports.Comms.PalmCall={_pending:{},_id:1,_callMojo:function(a,b,c){var d=this;return(new Future).now(function(f){var e=d._id++;f.pending=new Mojo.Service.Request(a,{method:b,parameters:c||{},onSuccess:f.callback(function(a){d._pending[e]=void 0;f.result=a}),onFailure:f.callback(function(a){d._pending[e]=void 0;throw Err.create(a.errorCode||-1,a.errorText||"Unknown PalmCall failure",a.exception);})});f.palmCallId=e;d._pending[e]=f})},_cancelMojo:function(a){this._pending[a.palmCallId]= void 0;a.pending.cancel()},_callTriton:function(a,b,c){return(new Future).now(this,function(d){Assert.requireString(a,"PalmCall.call: url parameter must be a string, was #{type}",{type:typeof a});Assert.requireString(b,"PalmCall.call: cmd parameter must be a string, was #{type}",{type:typeof b});Assert.requireJSONObject(c,"PalmCall.call: args parameter must be a valid JSON object, was #{type}",{type:typeof c});0<b.length&&("/"!=a.charAt(a.length-1)&&(a+="/"),a+=b);this._handle||(console.error("Foundations.PalmCall: Service bus handle not set! Use PalmCall.register(handle) to set up a bus handle"), this._handle=new webOS.Handle("",!1));d.pending=(!0===c.subscribe||!0===c.watch?this._handle.call:this._handle.callOneReply).call(this._handle,a,JSON.stringify(c),d.callback(function(b){if(d.pending){var e;try{e=JSON.parse(b.payload())}catch(g){throw b=Err.create(-1,"PalmCall.call: Bad JSON in service message from "+b.applicationID()+"("+b.sender()+'): "'+b.payload()+'"',g),b.response=e,b;}if(!1===e.returnValue||e.errorCode||e.errorText)throw b=Err.create(e.errorCode||-1,a+" "+JSON.stringify(c)+": "+ (e.errorText||"Unknown PalmCall failure"),e.exception),b.response=e,b;d.result=e}}))})},_cancelTriton:function(a){this._handle.cancel(a.pending);a.pending=void 0},_registerTriton:function(a,b){if("undefined"!==typeof this._handle)throw Error("_registerTriton: don't call this function more than once");this._handle=a},_callNode:function(a,b,c){return(new Future).now(this,function(d){Assert.requireString(a,"PalmCall.call: url parameter must be a string, was #{type}",{type:typeof a});Assert.requireString(b, "PalmCall.call: cmd parameter must be a string, was #{type}",{type:typeof b});Assert.requireJSONObject(c,"PalmCall.call: args parameter must be a valid JSON object, was #{type}",{type:typeof c});0<b.length&&("/"!=a.charAt(a.length-1)&&(a+="/"),a+=b);this._handle||(console.error("Foundations.PalmCall: Service bus handle not set! Use PalmCall.register(handle) to set up a bus handle"),this._handle=new PalmBus.Handle("",!1));d.pending=(!0===c.subscribe?this._handle.subscribe:!0===c.watch?this._handle.watch: this._handle.call).call(this._handle,a,JSON.stringify(c));d.pending.addListener("response",d.callback(function(b){var e;try{e=JSON.parse(b.payload())}catch(g){throw b=Err.create(-1,"PalmCall.call: Bad JSON in service message from "+b.applicationID()+"("+b.sender()+'): "'+b.payload()+'"',g),b.response=e,b;}if(!1===e.returnValue||e.errorCode||e.errorText)throw b=Err.create(e.errorCode||-1,a+" "+JSON.stringify(c)+": "+(e.errorText||"Unknown PalmCall failure"),e.exception),b.response=e,b;d.result=e}))})}, _cancelNode:function(a){a.pending&&a.pending.cancel();a.pending=void 0},_registerNode:function(a,b){if("undefined"!==typeof this._handle)throw Error("_registerNode: don't call this function more than once");this._handle=a},setup:function(){EnvironmentUtils.isBrowser()?(PalmCall.call=PalmCall._callMojo,PalmCall.cancel=PalmCall._cancelMojo,PalmCall.register=function(){}):EnvironmentUtils.isTriton()?(PalmCall.call=PalmCall._callTriton,PalmCall.cancel=PalmCall._cancelTriton,PalmCall.register=PalmCall._registerTriton): (PalmBus=require("palmbus"),PalmCall.call=PalmCall._callNode,PalmCall.cancel=PalmCall._cancelNode,PalmCall.register=PalmCall._registerNode)}},fs;function loadFileNode(a){return fs.readFileSync(a,"utf8")}function loadFileMojo(a){return palmGetResource(a,!0)}EnvironmentUtils.isNode()?(fs=require("fs"),exports.Comms.loadFile=loadFileNode):exports.Comms.loadFile=loadFileMojo;var Assert=exports.Assert; Assert._templateReplace=function(a,b){if(a&&"function"===typeof a.replace)for(var c in b)if(b.hasOwnProperty(c))for(;;){var d=b[c];void 0===d?d="undefined":null===d&&(d="null");var f=a;a=a.replace("#{"+c+"}",d.toString());if(f===a)break}return a};Assert._throwMsg=function(a,b,c,d){a||(a=b,c=d);a=Assert._templateReplace(a,c);throw Error(a);};Assert._squelchLogs=!1; Assert._logMsg=function(a,b,c,d){a||(a=b,c=d);a=Assert._templateReplace(a,c);Assert._lastLogMsg=a;Assert._squelchLogs||("undefined"!==typeof Mojo?Mojo.Log.error(a):console.error(a))};Assert.require=function(a,b,c){a||Assert._throwMsg(b,"Assert.require failed",c)};Assert.requireFalse=function(a,b,c){a&&Assert._throwMsg(b,"Assert.requireFalse failed",c)};Assert.requireEqual=function(a,b,c,d){a!=b&&Assert._throwMsg(c,"Assert.requireEqual: #{a} != #{b}",d,{a:a,b:b})}; Assert.requireIdentical=function(a,b,c,d){a!==b&&Assert._throwMsg(c,"Assert.requireIdentical: #{a} !== #{b}",d,{a:a,b:b})};Assert.requireArray=function(a,b,c){void 0!==a&&"[object Array]"===Object.prototype.toString.apply(a)||Assert._throwMsg(b,"Assert.requireArray: #{a} is not an Array",c,{a:a})};Assert.requireFunction=function(a,b,c){"function"!==typeof a&&Assert._throwMsg(b,"Assert.requireFunction: #{a} is not a Function",c,{a:a})}; Assert.requireString=function(a,b,c){"string"===typeof a||a&&(a instanceof String||"String"===a.constructor.name)||Assert._throwMsg(b,"Assert.requireString: #{a} is not a String",c,{a:a})};Assert.requireNumber=function(a,b,c){"number"===typeof a||"object"===typeof a&&(a instanceof Number||"Number"===a.constructor.name)||Assert._throwMsg(b,"Assert.requireNumber: #{a} is not a Number",c,{a:a})}; Assert.requireObject=function(a,b,c){"object"===typeof a&&null!==a||Assert._throwMsg(b,"Assert.requireObject: #{a} is not an Object",c,{a:a})};Assert.requireJSONObject=function(a,b,c){var d=Object.prototype.toString.apply(a);(d="[object Array]"!==d&&"[object Object]"!=d)&&Assert._throwMsg(b,"Assert.requireJSONObject: #{a} is not a valid JSON Object",c,{a:a});return!d}; Assert.requireClass=function(a,b,c,d){void 0!==a&&a.constructor===b||Assert._throwMsg(c,'Assert.requireClass: expected "#{a}", was "#{b}"',d,{a:b.name,b:a.constructor.name})};Assert.requireDefined=function(a,b,c){void 0===a&&Assert._throwMsg(b,"Assert.requireDefined: argument undefined",c)};Assert.requireMatch=function(a,b,c,d){a.match(b)||Assert._throwMsg(c,"Assert.requireMatch: no match found",d)}; Assert.requireProperty=function(a,b,c,d){for(var f in b)if(b.hasOwnProperty(f)){var e=b[f];a[f]!==e&&Assert._throwMsg(c,"Assert.requireProperty: obj.#{a} != #{b}",d,{a:f,b:e})}};Assert.requireError=function(a,b,c,d,f,e){try{b.apply(a,c)}catch(g){if(!d||g==d)return;Assert._throwMsg(f,"Assert.requireError: error thrown was '#{a}', instead of '#{e}'",e,{e:d,a:g})}Assert._throwMsg(f,"Assert.requireError: no error thrown",e)}; Assert.assert=function(a,b,c){a||Assert._logMsg(b,"Assert.assert failed",c);return a};Assert.assertFalse=function(a,b,c){a&&Assert._logMsg(b,"Assert.assertFalse failed",c);return!a};Assert.assertEqual=function(a,b,c,d){var f=a!=b;f&&Assert._logMsg(c,"Assert.assertEqual: #{a} != #{b}",d,{a:a,b:b});return!f};Assert.assertIdentical=function(a,b,c,d){var f=a!==b;f&&Assert._logMsg(c,"Assert.assertEqual: #{a} !== #{b}",d,{a:a,b:b});return!f}; Assert.assertArray=function(a,b,c){var d=void 0===a||"[object Array]"!==Object.prototype.toString.apply(a);d&&Assert._logMsg(b,"Assert.assertArray: #{a} is not an Array",c,{a:a});return!d};Assert.assertFunction=function(a,b,c){var d="function"!==typeof a;d&&Assert._logMsg(b,"Assert.assertFunction: #{a} is not a Function",c,{a:a});return!d}; Assert.assertString=function(a,b,c){var d="string"!==typeof a;if(d){if(a&&(a instanceof String||"String"===a.constructor.name))return!0;Assert._logMsg(b,"Assert.assertString: #{a} is not a String",c,{a:a})}return!d};Assert.assertNumber=function(a,b,c){var d="number"!==typeof a;if(d){if("object"===typeof a&&(a instanceof Number||"Number"===a.constructor.name))return!0;Assert._logMsg(b,"Assert.assertNumber: #{a} is not a Number",c,{a:a})}return!d}; Assert.assertObject=function(a,b,c){var d="object"!==typeof a||null===a;d&&Assert._logMsg(b,"Assert.assertObject: #{a} is not an Object",c,{a:a});return!d};Assert.assertClass=function(a,b,c,d){var f=void 0!==a&&a.constructor===b;f||Assert._logMsg(c,'Assert.assertClass: expected "#{a}", was "#{b}"',d,{a:b.name,b:a.constructor.name});return f};Assert.assertDefined=function(a,b,c){(a=void 0!==a)||Assert._logMsg(b,"Assert.assertDefined: argument undefined",c);return a}; Assert.assertMatch=function(a,b,c,d){(a=a.match(b))||Assert._logMsg(c,"Assert.assertMatch: no match found",d);return a};Assert.assertProperty=function(a,b,c,d){for(var f in b)if(b.hasOwnProperty(f)){var e=b[f];if(a[f]!==e)return Assert._logMsg(c,"Assert.assertProperty: obj.#{a} != #{b}",d,{a:f,b:e}),!1}return!0}; Assert.assertError=function(a,b,c,d,f,e){try{b.apply(a,c)}catch(g){if(!d||g==d)return!0;Assert._logMsg(f,"Assert.assertError: error thrown was '#{a}', instead of '#{e}'",e,{e:d,a:g});return!1}Assert._logMsg(f,"Assert.assertError: no error thrown",e);return!1};Assert.assertJSONObject=function(a,b,c){var d=Object.prototype.toString.apply(a);(d="[object Array]"!==d&&"[object Object]"!=d)&&Assert._logMsg(b,"Assert.assertJSONObject: #{a} is not a valid JSON Object",c,{a:a});return!d}; var defaultLocale,create$L=exports.Localization.create$L=function(a,b){var c=readStringTable(b?makeLocale(b):defaultLocale,a+"resources","strings.json");return function(a){return c[a]||a}};function readStringTable(a,b,c){function d(a){try{return JSON.parse(palmGetResource(b+"/"+a+"/"+c))}catch(d){}}var f=d(a.base);if(!f){f=d(a.language)||{};a=d(a.region);for(var e in a)f[e]=a[e]}return f}function makeLocale(a){return{base:a,language:a.slice(0,2),region:a.replace("_","/")}} defaultLocale="undefined"===typeof document||"undefined"===typeof PalmSystem?makeLocale("en_us"):makeLocale(PalmSystem.locale);
+var MojoLoader=require("mojoloader.js");exports.Control={};exports.Data={};exports.Comms={};exports.IO={};exports.Assert={};exports.Localization={};var PalmBus;exports.onLoad=function(){exports.Comms.AjaxCall.setup();exports.Comms.PalmCall.setup()}; var EnvironmentUtils=exports.EnvironmentUtils={runtime:function(){return"undefined"!==typeof root&&root.process&&root.process.version?"node":"undefined"!==typeof webOS?"triton":"browser"},isBrowser:function(){return"browser"===this.runtime()},isTriton:function(){return"triton"===this.runtime()},isNode:function(){return"node"===this.runtime()}},Class=exports.Class={create:function(a,b){function c(){this.initialize.apply(this,arguments)}b?b.__proto__=a.prototype:(b=a||{},b.__proto__=this._base);b.constructor= c;"undefined"!==typeof inBuiltinEnv&&inBuiltinEnv?setPrototype(c,b):c.prototype=b;return c},_base:{initialize:function(){},$super:function(a){var b=this;if(a._super)return function(){return a._super.apply(b,arguments)};var c=a.name;if(!c)throw Err.create(-1,"No method name:"+a);for(var d=this.__proto__;d;d=d.__proto__)if(d[c]===a){for(d=d.__proto__;d;d=d.__proto__){var f=d[c];if(f)return a._super=f,function(){return f.apply(b,arguments)}}break}throw Err.create(-1,"Method not found: "+c);}}},Err=exports.Err= {create:function(a,b,c){b=Error(b);b.errorCode=void 0!==a?a:-1;b.innerError=c;b.toString=this._toString;return b},_toString:function(){return Err._toFullString(this)+(this.innerError?"; inner"+Err._toFullString(this.innerError):"")},_toFullString:function(a){return a.message?"Error: "+a.message:"Error: "+JSON.stringify(a)}},ArrayUtils=exports.ArrayUtils={clear:function(a){return a.splice(0,a.length)}},StringUtils=exports.StringUtils={parseQueryString:function(a,b){var c=a.indexOf("?"), d=a.indexOf("#"),d=-1<d?d:a.length;a=a.substring(-1<c?c+1:0,d);for(var c={},d=a.split(b||"&"),f=d.length,e=0;e<f;++e){var g=d[e].split("="),h=decodeURIComponent(g.shift()),k=void 0;0<g.length&&(k=1<g.length?g.join("="):g[0],k=decodeURIComponent(k));h&&(c.hasOwnProperty(h)?(g=c[h],"array"===ObjectUtils.type(g)?g.push(k):g=[g,k],c[h]=g):c[h]=k)}return c},camelize:function(a){return a.replace(/-(.?)/g,function(a,c){return c?c.toUpperCase():""})},startsWith:function(a,b){return 0===a.indexOf(b)},endsWith:function(a, b){var c=a.length-b.length;return 0<=c&&a.indexOf(b,c)===c},isBlank:function(a){return/^\s*$/.test(a)},includes:function(a,b){return-1!==a.indexOf(b)},entityRegex:/[<>&]/g,unentityRegex:/(&lt;)|(&gt;)|(&amp;)/g,escapeCharacterMap:{"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},unescapeCharacterMap:{"&lt;":"<","&gt;":">","&amp;":"&","&quot;":'"',"&apos;":"'"},escapeCommon:function(a,b,c){return a.replace(b,function(a){return c[a]})},escapeHTML:function(a){return StringUtils.escapeCommon(a, StringUtils.entityRegex,StringUtils.escapeCharacterMap)},unescapeHTML:function(a){return StringUtils.escapeCommon(a,StringUtils.unentityRegex,StringUtils.unescapeCharacterMap)},stripTags:function(a){return a.replace(/<\/?[^>]+>/gi,"")},stripScripts:function(a){return a.replace(/<script[^>]*>[\S\s]*?<\/script>/img,"")}},ObjectUtils=exports.ObjectUtils={type:function(a){return null===a?"null":void 0===a?"undefined":"number"==typeof a?"number":"string"==typeof a?"string":!0===a||!1===a?"boolean":"[object Array]"== Object.prototype.toString.call(a)?"array":"function"==typeof a?"function":"object"},clone:function(a,b,c){return this._clone(a,b||{},"$",c||function(a,b){return a})},_clone:function(a,b,c,d){switch(this.type(a)){case "null":return d(null,c);case "undefined":return d(void 0,c);case "number":case "boolean":case "string":return d(a,c);case "array":return d(this._cloneArray(a,b,c,d),c);case "function":return d(b.ignoreFunctions?void 0:a,c);default:return d(this._cloneObject(a,b,c,d),c)}},_cloneObject:function(a, b,c,d){var f={},e=0,g=0,h;for(h in a)if(!b.ignoreUnderscoreProperties||"_"!=h.charAt(0)){var k=this._clone(a[h],b,c+"."+h,d);void 0!==k&&(f[h]=k,valid=1,e++);g++}"__partial"in a&&e++;g!=e&&(b.ignorePartialObjects&&!0!==a.__partial)&&(e=0);return!b.ignoreEmptyObjects||0<e?f:void 0},_cloneArray:function(a,b,c,d){for(var f=[],e=a.length,g=0;g<e;g++){var h=this._clone(a[g],b,c+"["+g+"]",d);void 0===h&&b.ignoreEmptyArrays||f.push(h)}return 0<f.length||!b.ignoreEmptyArrays?f:void 0},toQueryString:function(a){var b, c=[];for(b in a)if(a.hasOwnProperty(b)){var d=a[b],f=ObjectUtils.type(d),e=encodeURIComponent(b);switch(f){case "function":break;case "null":case "undefined":c.push(e);break;case "number":case "string":case "boolean":c.push(e+"="+encodeURIComponent(d));break;case "array":for(var f=d.length,g=0;g<f;++g)c.push(e+"="+encodeURIComponent(d[g]));break;case "object":break;default:throw Error("Can't convert unknown object type \""+f+'" to a query string');}}return c.join("&")}},Model=exports.Model={_token:1, _allscenes:{controller:{}},update:function(a,b,c,d){return this._update(a,b,c,d,!1)},delay:function(){var a=this;return{update:function(b,c,d,f){a._update(b,c,d,f,!0)},finish:function(b){a._sendPending(b);a._sendPending(a._allscenes)}}},create:function(a,b){this._notifyListeners({type:"create",model:b,diff:{},who:a},b,!1)},remove:function(a,b){this._notifyListeners({type:"remove",model:b,diff:this.merge({},b).old,who:a},b,!1)},merge:function(a,b,c){var d=!1,f={};if(b)for(var e in b)if("_"!=e.charAt(0)){var g= b[e];if(!Object.isFunction(g)){var h=a[e];if(null===h||void 0===h||null===g||void 0===g||"boolean"==typeof g||"number"==typeof g||Object.isString(g)||Object.isArray(g)){if(h!=g||c)f[e]=h,a[e]=g,d=!0}else g=this.merge(h,g,c),g.modified&&(f[e]=g.old,d=!0)}}return{modified:d,old:f}},setParent:function(a,b){a._webos$foundations$model$parent=b},addListener:function(a,b,c){b._webos$foundations$model$listeners||(b._webos$foundations$model$listeners={});a||(a=this._allscenes);a._webos$foundations$model$pending|| this._setupScene(a);a._webos$foundations$model$count++;var d=b._webos$foundations$model$listeners[a._webos$foundations$model$token];d||(d={who:a,pending:null,call:[]},b._webos$foundations$model$listeners[a._webos$foundations$model$token]=d);d.call.push(c)},removeListener:function(a,b,c){a||(a=this._allscenes);if(b._webos$foundations$model$listeners&&a._webos$foundations$model$token){if(b=b._webos$foundations$model$listeners[a._webos$foundations$model$token])if(c)for(var d=0;d<b.call.length;d++){if(b.call[d]=== c){b.call.splice(d,1);a._webos$foundations$model$count--;break}}else a._webos$foundations$model$count=0,b.call=[];0==a._webos$foundations$model$count&&this._cleanupScene(a)}},_update:function(a,b,c,d,f){void 0===c&&void 0===d&&(d=!0);c=this.merge(b,c,d);(d||c.modified)&&this._notifyListeners({type:"update",model:b,diff:c.old,who:a},b,f);return c.modified},_notifyListeners:function(a,b,c){var d=b._webos$foundations$model$listeners;if(d)for(var f in d)if("toJSON"!=f){var e=d[f];if(e.call){var g=e.who.controller; if(c||g&&g.isActive&&!g.isActive()&&a.who!=e.who){g=e.pending;g||(g={},e.pending=g);var h=a.model._webos$foundations$model$token,k=g[h];if(k){"remove"==a.type&&(k.type="remove");for(l in a.diff)k.diff[l]=a.diff[l];a.who!=k.who&&(k.who=null)}else{var k={},l;for(l in a)k[l]=a[l];k.diff={};for(l in a.diff)k.diff[l]=a.diff[l];g[h]=k;e.who._webos$foundations$model$pending.push(e)}}else for(g=0;g<e.call.length;g++)e.call[g](a)}}b._webos$foundations$model$parent&&this._notifyListeners(a,b._webos$foundations$model$parent, !1)},_sendPending:function(a){var b=a._webos$foundations$model$pending;if(b){a._webos$foundations$model$pending=[];a=b.length;for(var c=0;c<a;c++){var d=b[c],f=d.pending;d.pending=void 0;for(var e in f)d.call(f[e])}}},_setupScene:function(a){a._webos$foundations$model$token=this._token++;a._webos$foundations$model$pending=[];a._webos$foundations$model$count=0;if(a.controller.sceneElement){if(!this._aboutToActivateBound){var b=this;this._aboutToActivateBound=function(a){b._sendPending(a.target._webos$foundations$scene)}}a.controller.sceneElement._webos$foundations$scene= a;a.controller.sceneElement.addEventListener(Mojo.Event.aboutToActivate,this._aboutToActivateBound)}},_cleanupScene:function(a){a.controller.sceneElement&&(a.controller.sceneElement._webos$foundations$scene=void 0,a.controller.sceneElement.removeEventListener(Mojo.Event.aboutToActivate,this._aboutToActivateBound));a._webos$foundations$model$pending=void 0;a._webos$foundations$model$token=void 0;a._webos$foundations$model$count=void 0}}; function Future(a){this._insidefuture=-1;this._then=[];this._result={result:a,exception:void 0,isset:0<arguments.length,wasread:!1,cancelled:!1}}Future.prototype.now=function(a,b,c){return this._result.cancelled?this:this._docall(!0,a,b,c)};Future.prototype.then=function(a,b,c){return this._result.cancelled?this:this._docall(!1,a,b,c)}; Future.prototype.whilst=function(a,b,c,d){"function"===typeof a?(d=c,c=b,b=a,a=null):Assert.requireObject(a,"Future.whilst(): scope must be an object, was #{type}",{type:typeof a});Assert.requireFunction(b,"Future.whilst(): conditionfunc must be a function, was #{type}",{type:typeof b});Assert.requireFunction(c,"Future.whilst(): func must be a function, was #{type}",{type:typeof c});void 0!==d&&Assert.requireFunction(d,"Future.whilst(): errorfunc must be a function, was #{type}",{type:typeof d}); return this.then(this,function e(){this.getResult();b.call(a,this)?null!==a?this.now(a,c,d).then(this,e):this.now(c,d).then(this,e):this.result=this.result})};Future.prototype.immediate=function(a){this._result={result:a,exception:void 0,isset:!0,cancelled:!1,wasread:!1};return this};Future.prototype.cancel=function(){this._result.isset=!1;this._result.cancelled=!0;this._then=[]}; Future.prototype.status=function(){var a=this._result;return a.isset?a.exception?"exception":"result":a.cancelled?"cancelled":"none"};Future.prototype.onError=function(a){this._errorfunc=a}; Future.prototype._docall=function(a,b,c,d){var f;"function"===typeof b&&(d=c,c=b,b=null);d||(d=this._errorfunc);if(a){this._insidefuture=0;try{f=c.call(b,this),void 0!==f&&(f&&"function"===typeof f.then?this.nest(f):this.setResult(f))}catch(e){if(this._logexception(e),this._result={result:void 0,exception:e,isset:!1,cancelled:!1,wasread:!1},d)try{d.call(b,this)}catch(g){this._logexception(g)}else this._result.isset=!0}this._insidefuture=-1;0<this._then.length&&this._maybeDispatch()}else if(-1===this._insidefuture){if("[object Array]"=== Object.prototype.toString.call(c))for(a=c.length,f=0;f<a;f++)this._then.push({f:c[f],e:d,c:b});else this._then.push({f:c,e:d,c:b});this._maybeDispatch()}else if("[object Array]"===Object.prototype.toString.call(c))for(a=c.length,f=0;f<a;f++)this._then.splice(this._insidefuture++,0,{f:c[f],e:d,c:b});else this._then.splice(this._insidefuture++,0,{f:c,e:d,c:b});return this}; Future.prototype.callback=function(a,b){if("function"===typeof a)b=a,a=void 0;else if(!b)throw Error("Must define function");return Queue.current.wrap(this,function(){this._insidefuture=0;try{var c=b.apply(a,arguments);void 0!==c&&(c&&"function"===typeof c.then?this.nest(c):this.setResult(c))}catch(d){this._logexception(d),this._result={result:void 0,exception:d,isset:!0,cancelled:!1,wasread:!1}}this._insidefuture=-1;0<this._then.length&&this._maybeDispatch()})}; Future.prototype.nest=function(a){Assert.requireObject(a,"Future.nest() expects to be passed a Future, was of type #{type}",{type:typeof a});Assert.requireObject(a._result,"Future.nest() expects to be passed a Future");a._result.isset?(this._result=a._result,0<this._then.length&&this._maybeDispatch()):a.then(this,function(){try{this.result=a.result}catch(b){this.exception=b}});return this}; Future.prototype._maybeDispatch=function(){if(-1===this._insidefuture){for(;0<this._then.length&&this._result.isset;){this._insidefuture=0;var a=this._then.shift();try{this._result.isset=!1;var b;b=a.e&&this._result.exception?a.e.call(a.c,this):a.f.call(a.c,this);void 0!==b&&(b&&"function"===typeof b.then?this.nest(b):this.setResult(b));!this._result.wasread&&this._result.exception&&(this._result.isset=!0)}catch(c){if(this._logexception(c),this._result={result:void 0,exception:c,isset:!1,cancelled:!1, wasread:!1},a.e)try{a.e.call(a.c,this)}catch(d){this._logexception(d)}else this._result.isset=!0}}this._insidefuture=-1}};Future.prototype._logexception=function(a){console.error(a.stack||a)};Future.prototype.getResult=function(){return this.result};Future.prototype.setResult=function(a){this.result=a};Future.prototype.getException=function(){return this.exception};Future.prototype.setException=function(a){this.exception=a}; Future.prototype.__defineGetter__("result",function(){this._result.wasread=!0;if(this._result.exception)throw this._result.exception;return this._result.result});Future.prototype.__defineSetter__("result",function(a){if(!this._result.cancelled){if(this._result.exception&&!this._result.wasread)throw this._result.wasread=!0,this._result.exception;this._result={result:a,exception:void 0,isset:!0,cancelled:!1,wasread:!1};0<this._then.length&&this._maybeDispatch()}}); Future.prototype.__defineGetter__("exception",function(){this._result.wasread=!0;return this._result.exception});Future.prototype.__defineSetter__("exception",function(a){this._result={result:void 0,exception:a,isset:!0,cancelled:!1,wasread:!1};0<this._then.length&&this._maybeDispatch()});exports.Control.Future=Future; function FSM(a,b){this._context=b||a;this._states=a;this._state="__uninitialized";var c=this;this._context.go=function(a){c.go(a)};this._context.event=function(){return c.event.apply(c,arguments)};this._states.__uninitialized={};setTimeout(function(){c.go("__start")},0)}exports.Control.FSM=FSM;FSM.prototype.currentState=function(){return this._state}; FSM.prototype.go=function(a){for(;this._state!=a;){console.log("state "+this._state+" -> change to -> "+a);if(!a||!this._states[a]){console.log("Non-existstant state "+a);break}var b=this._states[this._state];b&&(b.__exit&&b.__exit.call(this._context),(b=b["__to_"+a])&&b.call(this._context));var b=this._states[a],c=b["__from_"+this._state];this._state=a;c&&c.call(this._context);a=b.__enter&&b.__enter.call(this._context)||this._state}}; FSM.prototype.event=function(a){console.log("state "+this._state+" -> event "+a);var b=this._states[this._state][a];b||(b=this._states[this._state].__any);if(b){try{var c=b.apply(this._context,Array.prototype.slice.call(arguments,1));c&&this.go(c)}catch(d){if(console.log(d.stack),b=this._states[this._state].__exception)try{(c=b.call(this._context,d))&&this.go(c)}catch(f){console.log(f.stack)}}return!0}return!1}; var mapReduce=exports.Control.mapReduce=function(a,b){return(new Future).now(function(c){function d(a){return(new Future).immediate(a)}function f(a){for(var b=new Future,c=0;c<a.length;c++)if(a[c].exception)return b.exception=a[c].exception,b;return b.immediate(a)}for(var e=a.map||d,g=a.reduce||f,h=b?b.length:0,k=h+1,l=[],m=0;m<h;m++)e(b[m]).then(b[m],function(a){var b={item:this};try{b.result=a.result}catch(d){b.exception=d}l.push(b);--k||c.nest(g(l))});--k||c.nest(g(l))})}; function _SubQ(a,b){this._queue=a;this._idx=b;this._list=[]}_SubQ.prototype.defer=function(a,b){this._list.push({scope:a,func:b,args:2>=arguments.length?void 0:Array.prototype.slice.call(arguments,2)});this._queue._dispatch(this._idx)};_SubQ.prototype.wrap=function(a,b){var c=this;return function(){c._list.push({scope:a,func:b,args:arguments});c._queue._dispatch(c._idx)}};_SubQ.prototype._next=function(){return this._list.shift()}; var Queue={_qs:[],_start:0,_current:void 0,_normal:1,q:function(a){void 0===a&&(a=this._normal);this._qs[a]||(this._qs[a]=new _SubQ(this,a));return this._qs[a]},defer:function(){var a=this.current;a.defer.apply(a,arguments)},_dispatch:function(a){if(this._running)a<this._start&&(this._start=a);else{this._start=a;var b=this;this._running=setTimeout(function d(){for(;b._start<b._qs.length;){var a=b._qs[b._start];if(a&&(a=a._next())){b._current=b._start;try{a.func.apply(a.scope,a.args)}catch(e){console.error(e.stack|| e)}b._current=void 0;continue}b._start++;if(b._start>b._normal&&b._start<b._qs.length){b._running=setTimeout(d,0);return}}b._running=void 0},0)}}};Queue.__defineGetter__("high",function(){return this.q(0)});Queue.__defineGetter__("normal",function(){return this.q(this._normal)});Queue.__defineGetter__("low",function(){return this.q(2)});Queue.__defineGetter__("current",function(){return this.q(this._current)});exports.Control.Queue=Queue; function Activity(a,b,c){this._trace("initialize",arguments);this._activity={name:a,description:b};this._activity.type=c?{background:!0}:{foreground:!0};this._refcount=1;this._subscription=this._owner=void 0;this.lastEvent=Activity.Event.start;this.serial=void 0;this.name=a} Activity.prototype={_service:"palm://com.palm.activitymanager/",_log:!1,_trace:function(a,b){if(this._log){for(var c="activity.js -> Activity."+a+"(",d=!0,f=0;f<b.length;f++)d?d=!1:c+=", ",c+=b[f];console.log(c+")")}},create:function(){this._trace("create",arguments);if(this._activityId)throw Err.create(-1,"Cannot create an activity if one has already been created");return this._create(!1)},start:function(a){this._trace("start",arguments);return this._activityId?PalmCall.call(this._service,"start", {activityId:this._activityId}):this._create(!0)},_create:function(a){this._trace("_create",arguments);return(new Future).now(this,function(b){this._subscription=PalmCall.call(this._service,"create",{activity:this._activity,start:a,replace:this._replace,subscribe:void 0===this._activity.callback}).then(this,function(a){this._activityId=a.result.activityId;this._owner=!0;a=a.result;b.result=a;this._monitor();a.event&&this._updateState(a.event)})})},adopt:function(a){this._trace("adopt",arguments);if(this._subscription)throw Err.create(-1, "Cannot adopt an activity if one has already been created");return(new Future).now(this,function(b){this.name="ActivityManager activity"+a;this._activityId=a;var c={activityId:this._activityId,subscribe:!0};this.serial&&(c.serial=this.serial);this._subscription=PalmCall.call(this._service,"adopt",c).then(this,function(a){if(a.result.adopted||a.result.event&&"orphan"===a.result.event)this._owner=!0;b.result=a.result;this._monitor()},function(a){b.setException(a.exception)})})},monitor:function(a){this._trace("monitor", arguments);return this._subscription?(console.warn("Shouldn't call monitor() when already subscribed."),new Future(this.lastEvent)):(new Future).now(this,function(b){this.name="Monitored activityID"+a;this._activityId=a;this._subscription=PalmCall.call(this._service,"monitor",{activityId:this._activityId,subscribe:!0}).then(this,function(a){b.result=a.result;this._monitor()},function(a){b.setException(a.exception)})})},complete:function(a){this._trace("complete",[this.name]);this._refcount=0;if(this._owner){var b= {activityId:this._activityId};a&&(b.restart=!0);this.serial&&(b.serial=this.serial);return PalmCall.call(this._service,"complete",b).then(this,function(a){void 0!==this._subscription&&(this._trace("unsubscribe(owned)",[]),PalmCall.cancel(this._subscription),this._subscription=void 0);a.result=a.result})}a&&console.error("Tried to complete&restart an activity we don't own - "+this._activityId);void 0!==this._subscription&&(this._trace("unsubscribe(not owned)",[]),PalmCall.cancel(this._subscription), this._subscription=void 0)},cancel:function(){this._trace("cancel",arguments);this._refcount=0;return PalmCall.call(this._service,"cancel",{activityId:this._activityId})},setTrigger:function(a,b,c){this._trace("setTrigger",arguments);this._activity.trigger={method:b,key:a,params:c};return this},setScheduleInterval:function(a,b){this._trace("setScheduleInterval",arguments);this._activity.schedule={interval:a,within:b};return this},setScheduleTime:function(a,b,c){this._trace("setScheduleTime",arguments); this._activity.schedule={start:a,end:b,within:c};return this},setRequirements:function(a){this._trace("setRequirements",arguments);this._activity.requirements=a;return this},setCallback:function(a,b){this._trace("setCallback",arguments);this._activity.callback={method:a,params:b};return this},setUserInitiated:function(a){this._trace("setUserInitiated",arguments);this._activity.type.userInitiated=a;return this},setExplicit:function(a){this._trace("setExplicit",arguments);this._activity.type.explicit= a;return this},setPersist:function(a){this._trace("setPersist",arguments);this._activity.type.persist=a;return this},setReplace:function(a){this._trace("setReplace",arguments);this._replace=a;return this},setPower:function(a){this._trace("setPower",arguments);this._activity.type.power=a;return this},setPowerDebounce:function(a){this._trace("setPowerDebounce",arguments);this._activity.type.powerDebounce=a;return this},setMetadata:function(a){this._trace("setMetadata",arguments);this._activity.metadata= a;return this},onEvent:function(a){this._trace("onEvent",arguments);if(this._eventCallback)throw Err.create(-1,"Only supports one callback");this._eventCallback=a},_monitor:function(){this._trace("_monitor",arguments);this._subscription?this._subscription.then(this,function b(c){this._trace("update ",[JSON.stringify(c.result)]);try{var d=c.result;this._subscription&&(this._subscription.then(this,b),this._updateState(d.event))}catch(f){console.error("Activity monitoring failed: activityId="+this._activityId+ ", activity="+JSON.stringify(this._activity)),console.error("exception was: "+f.stack)}}):console.warn("Foundations.activity: _monitor with no subscription active - probably completed already")},_updateState:function(a){this._trace("_updateState",[a]);this.lastEvent=a;if(a==Activity.Event.orphan)this._owner=!0;else if(a==Activity.Event.adopted)this._owner=!1;else if(a==Activity.Event.stop||a==Activity.Event.cancel||a==Activity.Event.complete)this._trace("_updateStatus: cancelling subscription",[]), PalmCall.cancel(this._subscription),this._subscription=void 0;this._eventCallback&&a&&this._eventCallback(a)}};Activity.Event={start:"start",stop:"stop",pause:"pause",cancel:"cancel",orphan:"orphan",adopted:"adopted",focused:"focused",unfocused:"unfocused",running:"running",yield:"yield",complete:"complete"};exports.Control.Activity=Activity; var DB=exports.Data.DB={get:function(a){return 0===a.length?new Future({returnValue:!0,results:[]}):this.execute("get",{ids:a})},put:function(a){return 0===a.length?new Future({returnValue:!0,results:[]}):this.execute("put",{objects:a})},find:function(a,b,c){return this.execute("find",{query:a,watch:b,count:c})},del:function(a,b){var c;if("[object Array]"==Object.prototype.toString.call(a)){if(0===a.length)return new Future({returnValue:!0,results:[]});c={ids:a}}else c={query:a,purge:!!b};return this.execute("del", c)},merge:function(a,b){var c;if("[object Array]"==Object.prototype.toString.call(a)){if(0===a.length)return new Future({returnValue:!0,results:[]});c={objects:a}}else c={query:a,props:b};return this.execute("merge",c)},reserveIds:function(a){return 0===a?new Future({returnValue:!0,ids:[]}):this.execute("reserveIds",{count:a})},putKind:function(a,b,c){return this.execute("putKind",{id:a,owner:b,indexes:c})},delKind:function(a){return this.execute("delKind",{id:a})},execute:function(a,b){return this.temp? PalmCall.call("palm://com.palm.tempdb/",a,b):PalmCall.call("palm://com.palm.db/",a,b)}},tempDBFactory=function(){this.temp=!0};tempDBFactory.prototype=DB;var TempDB=exports.Data.TempDB=new tempDBFactory;function TypedownDB(a,b,c,d){this._kind=a;this._sortKey=b;this._wordKeys=c;this._limit=d&&d.limit||50;this._trim=d&&d.trim||this._limit;this._style=d&&d.style||"words"}TypedownDB.prototype.__proto__=DB; TypedownDB.prototype.putKind=function(a,b,c){if(a&&a!=this._kind)throw Error("Attemping to putKind incompatible kind: found ",a+", requires "+this._kind);c.push({props:[{name:"typedown"}]});DB.putKind(this._kind,b,c)};TypedownDB.prototype.put=function(a){for(var b=a.length,c=0;c<b;c++)this._addTypedown(a[c]);return DB.put(a)};TypedownDB.prototype.merge=function(a,b){if("[object Array]"==Object.prototype.toString.call(a))for(var c=a.length,d=0;d<c;d++)this._addTypedown(a[d]);return DB.merge(a,b)}; TypedownDB.prototype.find=function(a,b,c){a=a||{};if(a.from&&a.from!=this._kind)throw Error("Attemping to query incompatible kind: found ",a.from+", requires "+this._kind);if(a.orderBy&&a.orderBy!=this._sortKey)throw Error("Attemping to orderBy incompatible key: found ",a.orderBy+", requires "+this._sortKey);a.from=this._kind;a.orderBy=this._sortKey;return DB.find(a,b,c)}; TypedownDB.prototype.search=function(a){a=this._cleanWords(a);return DB.find({from:this._kind,where:[{prop:"typedown",op:"%",val:a}],limit:this._limit}).then(this,function(a){var c=this._sortKey,d=a.result;d.sort(function(a,b){a=a[c]+a._id;b=b[c]+b._id;return a<b?-1:a==b?0:1});for(var f="",e=[],g=d.length,h=this._trim,k=0;k<g;k++){var l=d[k],m=l._id;if(m!=f){e.push(l);if(0>=--h)break;f=m}}a.result=e})}; TypedownDB.prototype._addTypedown=function(a){if(a._kind&&a._kind!=this._kind)throw Error("Attempting to put incompatible kind: found ",a._kind+", requires "+this._kind);a._kind=this._kind;for(var b=[],c=this._wordKeys.length,d=0;d<c;d++){var f=a[this._wordKeys[d]];if(f)switch(this._style){default:this._addWords(b,f);break;case "letters":this._addLetters(b,f)}}b.length&&(a.typedown=b)};TypedownDB.prototype._cleanWords=function(a){return a.replace(/[.!?,()-]/," ").replace(/\s+/," ").toLowerCase()}; TypedownDB.prototype._addWords=function(a,b){for(b=this._cleanWords(b);;){a.push(b);var c=b.indexOf(" ");if(-1==c)break;b=b.slice(c+1)}return a};TypedownDB.prototype._addLetters=function(a,b){for(b=this._cleanWords(b);0<b.length;)" "!=b.charAt(0)&&a.push(b),b=b.substring(1);return a}; var urlModule,httpModule,bufferModule,AjaxCall={ajaxCTimeout:null,ajaxCTimeoutValue:6E4,get:function(a,b){return this.call(AjaxCall.RequestMethod.GET,a,void 0,b)},head:function(a,b){return this.call(AjaxCall.RequestMethod.HEAD,a,void 0,b)},post:function(a,b,c){return this.call(AjaxCall.RequestMethod.POST,a,b,c)},_callMojo:function(a,b,c,d){return(new Future).now(this,function(f){d=d||{};a=a.toUpperCase();c&&a===AjaxCall.RequestMethod.GET&&(b=b+"?"+c,c=void 0);var e=new XMLHttpRequest;e.open(a,b); if(d.headers)for(var g in d.headers)d.headers.hasOwnProperty(g)&&e.setRequestHeader(g,d.headers[g]);e.onreadystatechange=f.callback(function(){if(4===e.readyState&&!e._complete)if(e._complete=!0,200<=e.status&&300>e.status){try{e.responseJSON=JSON.parse(e.responseText)}catch(a){}f.result=e}else throw Err.create(e.status,e.statusText);});e.send(c);f._ajax=e})},_cancelMojo:function(a){a._ajax.abort()},_callTriton:function(a,b,c,d){return(new Future).now(this,function(f){d=d||{};a=a.toUpperCase();c&& a!==AjaxCall.RequestMethod.POST&&(b=b.match("\\?")?b+"&"+c:b+"?"+c,c=void 0);var e=new webOS.Curl(b);d.headers&&e.setHeaders(d.headers);e.setOption(webOS.Curl.SSL_VERIFYPEER,0);e.setOption(webOS.Curl.SSL_VERIFYHOST,0);e.setOption(webOS.Curl.FOLLOWLOCATION,10);d.nocompression?e.setOption(webOS.Curl.ENCODING,"identity"):e.setOption(webOS.Curl.ENCODING,"");d.verbose&&e.setOption(webOS.Curl.VERBOSE,1);d.onRead&&(e.onread=d.onRead);var g={},h="";e.onheader=function(a){var b=a.indexOf(": ");if(-1!==b){var c= a.substring(0,b),b=a.substring(b+2,a.length-1);g[c]?("array"!=ObjectUtils.type(g[c])&&(g[c]=[g[c]]),g[c].push(b)):g[c]=b;h+=a;if(d.onHeader)try{d.onHeader(c,b)}catch(f){console.log("onHeader error: "+f)}}};switch(a){case AjaxCall.RequestMethod.POST:d.customRequest&&e.setOption(webOS.Curl.CUSTOMREQUEST,d.customRequest);e.post(c,f.callback(this,function(a){f._complete=!0;var b={responseText:a,getResponseHeader:function(a){return g[a]},getAllResponseHeaders:function(a){return h}};try{b.responseJSON= JSON.parse(a)}catch(c){}try{b.status=e.getInfo(webOS.Curl.CURLINFO_RESPONSE_CODE)}catch(d){}f.result=b}),f.callback(this,function(a,b){f._complete=!0;throw Err.create(a,b);}));break;case AjaxCall.RequestMethod.HEAD:e.setOption(webOS.Curl.NOBODY,1);e.setOption(webOS.Curl.HEADER,1);d.customRequest&&e.setOption(webOS.Curl.CUSTOMREQUEST,d.customRequest);e.get(f.callback(this,function(a){f._complete=!0;a={responseText:a,getResponseHeader:function(a){return g[a]},getAllResponseHeaders:function(a){return h}}; try{a.status=e.getInfo(webOS.Curl.CURLINFO_RESPONSE_CODE)}catch(b){}f.result=a}),f.callback(this,function(a,b){f._complete=!0;throw Err.create(a,b);}));break;default:d.customRequest&&e.setOption(webOS.Curl.CUSTOMREQUEST,d.customRequest),e.get(f.callback(this,function(a){f._complete=!0;var b={responseText:a,getResponseHeader:function(a){return g[a]},getAllResponseHeaders:function(a){return h}};try{b.responseJSON=JSON.parse(a)}catch(c){}try{b.status=e.getInfo(webOS.Curl.CURLINFO_RESPONSE_CODE)}catch(d){}f.result= b}),f.callback(this,function(a,b){f._complete=!0;throw Err.create(a,b);}))}f._handle=e;var k=this;f.getResponseStream=function(){return k._getResponseStream(f)}})},_foundations_io:void 0,_getResponseStream:function(a){this._foundations_io||(this._foundations_io=MojoLoader.require({name:"foundations.io",version:"1.0"})["foundations.io"]);return new this._foundations_io.AjaxStream(a._handle)},_cancelTriton:function(a){a._handle.abort()},_callNode:function(a,b,c,d){return(new Future).now(this,function(f){d= d||{};a=a.toUpperCase();c&&a!==AjaxCall.RequestMethod.POST&&(b=b.match("\\?")?b+"&"+c:b+"?"+c,c=void 0);d.customRequest&&(a=d.customRequest,a=a.toUpperCase());var e=urlModule.parse(b),g="https:"===e.protocol,h=parseInt(e.port,10)||(g?443:80),h=httpModule.createClient(h,e.host,g);h.addListener("error",function(a){f.exception=Err.create(a.errno,"httpClient error "+a.message)});var k={};k.host=e.host;k["Accept-Encoding"]="identity";g="ascii"===d.bodyEncoding?"ascii":"utf8";k["Content-Length"]="ascii"=== g?c&&c.length||0:c&&bufferModule.Buffer.byteLength(c)||0;k.Accept="*/*";k["Content-Type"]="application/x-www-form-urlencoded";k.Date=(new Date).toUTCString();Object.keys(d.headers||{}).forEach(function(a){k[a]=d.headers[a]});var l=e.pathname||"/";e.search&&(l+=e.search);var m={responseText:""},e=h.request(a,l,k),n=this;e.addListener("error",function(a){n.clearAjaxCTimeout();f.exception=Err.create(a.errno,"httpRequest error "+a.message)});e.addListener("response",function(a){function b(){n.clearAjaxCTimeout(); if(!c){c=!0;try{m.responseJSON=JSON.parse(m.responseText)}catch(a){}f.result=m}}f._response=a;m.status=a.statusCode;m.getResponseHeader=function(b){b=b.toLowerCase();return"set-cookie"===b?a.headers["set-cookie"].join(", "):a.headers[b]};m.getAllResponseHeaders=function(b){if(!m.allHeaders){b=[];for(var c in a.headers)a.headers.hasOwnProperty(c)&&b.push(""+c+": "+a.headers[c]);m.allHeaders=b.join("\r\n")}return m.allHeaders};if(d.onResponse&&"function"===typeof d.onResponse)d.onResponse(a.statusCode, a.headers);a.addListener("data",function(a){m.responseText+=a;if(d.onData&&"function"===typeof d.onData)d.onData(a)});a.addListener("error",function(a){n.clearAjaxCTimeout();f.exception=Err.create(a.errno,"httpResponse error "+a.message)});var c=!1;a.addListener("end",b);a.addListener("close",b)});this.clearAjaxCTimeout();this.ajaxCTimeout=setTimeout(function(){f.exception=Err.create(504,"Timeout received from ajaxCall ");try{console.log("Ajax call timeout hit. Canceling the call."),n.clearAjaxCTimeout(), AjaxCall.cancel(f)}catch(a){}},this.ajaxCTimeoutValue);e.end(c,g)})},_cancelNode:function(a){a._response&&(a._response.removeAllListeners(),a._response.connection.destroy(),delete a._response)},setup:function(){EnvironmentUtils.isBrowser()?(AjaxCall.call=AjaxCall._callMojo,AjaxCall.cancel=AjaxCall._cancelMojo):EnvironmentUtils.isTriton()?(AjaxCall.call=AjaxCall._callTriton,AjaxCall.cancel=AjaxCall._cancelTriton):(urlModule=require("url"),httpModule=require("http"),bufferModule=require("buffer"),AjaxCall.call= AjaxCall._callNode,AjaxCall.cancel=AjaxCall._cancelNode)},setCallTimeout:function(a){Assert.requireNumber(a,"AjaxCall.setCallTimeout: timeout parameter must be a number, was #{type}",{type:typeof a});this.ajaxCTimeoutValue=a},clearAjaxCTimeout:function(){try{this.ajaxCTimeout&&(clearTimeout(this.ajaxCTimeout),this.ajaxCTimeout=null)}catch(a){console.log("AjaxCall exception on clear timeout"+a)}},RequestMethod:{}};AjaxCall.RequestMethod.POST="POST";AjaxCall.RequestMethod.GET="GET"; AjaxCall.RequestMethod.HEAD="HEAD";exports.Comms.AjaxCall=AjaxCall; var PalmCall=exports.Comms.PalmCall={_pending:{},_id:1,_callMojo:function(a,b,c){var d=this;return(new Future).now(function(f){var e=d._id++;f.pending=new Mojo.Service.Request(a,{method:b,parameters:c||{},onSuccess:f.callback(function(a){d._pending[e]=void 0;f.result=a}),onFailure:f.callback(function(a){d._pending[e]=void 0;throw Err.create(a.errorCode||-1,a.errorText||"Unknown PalmCall failure",a.exception);})});f.palmCallId=e;d._pending[e]=f})},_cancelMojo:function(a){this._pending[a.palmCallId]= void 0;a.pending.cancel()},_callTriton:function(a,b,c){return(new Future).now(this,function(d){Assert.requireString(a,"PalmCall.call: url parameter must be a string, was #{type}",{type:typeof a});Assert.requireString(b,"PalmCall.call: cmd parameter must be a string, was #{type}",{type:typeof b});Assert.requireJSONObject(c,"PalmCall.call: args parameter must be a valid JSON object, was #{type}",{type:typeof c});0<b.length&&("/"!=a.charAt(a.length-1)&&(a+="/"),a+=b);this._handle||(console.error("Foundations.PalmCall: Service bus handle not set! Use PalmCall.register(handle) to set up a bus handle"), this._handle=new webOS.Handle("",!1));d.pending=(!0===c.subscribe||!0===c.watch?this._handle.call:this._handle.callOneReply).call(this._handle,a,JSON.stringify(c),d.callback(function(b){if(d.pending){var e;try{e=JSON.parse(b.payload())}catch(g){throw b=Err.create(-1,"PalmCall.call: Bad JSON in service message from "+b.applicationID()+"("+b.sender()+'): "'+b.payload()+'"',g),b.response=e,b;}if(!1===e.returnValue||e.errorCode||e.errorText)throw b=Err.create(e.errorCode||-1,a+" "+JSON.stringify(c)+": "+ (e.errorText||"Unknown PalmCall failure"),e.exception),b.response=e,b;d.result=e}}))})},_cancelTriton:function(a){this._handle.cancel(a.pending);a.pending=void 0},_registerTriton:function(a,b){if("undefined"!==typeof this._handle)throw Error("_registerTriton: don't call this function more than once");this._handle=a},_callNode:function(a,b,c){return(new Future).now(this,function(d){Assert.requireString(a,"PalmCall.call: url parameter must be a string, was #{type}",{type:typeof a});Assert.requireString(b, "PalmCall.call: cmd parameter must be a string, was #{type}",{type:typeof b});Assert.requireJSONObject(c,"PalmCall.call: args parameter must be a valid JSON object, was #{type}",{type:typeof c});0<b.length&&("/"!=a.charAt(a.length-1)&&(a+="/"),a+=b);this._handle||(console.error("Foundations.PalmCall: Service bus handle not set! Use PalmCall.register(handle) to set up a bus handle"),this._handle=new PalmBus.Handle("",!1));d.pending=(!0===c.subscribe?this._handle.subscribe:!0===c.watch?this._handle.watch: this._handle.call).call(this._handle,a,JSON.stringify(c));d.pending.addListener("response",d.callback(function(b){var e;try{e=JSON.parse(b.payload())}catch(g){throw b=Err.create(-1,"PalmCall.call: Bad JSON in service message from "+b.applicationID()+"("+b.sender()+'): "'+b.payload()+'"',g),b.response=e,b;}if(!1===e.returnValue||e.errorCode||e.errorText)throw b=Err.create(e.errorCode||-1,a+" "+JSON.stringify(c)+": "+(e.errorText||"Unknown PalmCall failure"),e.exception),b.response=e,b;d.result=e}))})}, _cancelNode:function(a){a.pending&&a.pending.cancel();a.pending=void 0},_registerNode:function(a,b){if("undefined"!==typeof this._handle)throw Error("_registerNode: don't call this function more than once");this._handle=a},setup:function(){EnvironmentUtils.isBrowser()?(PalmCall.call=PalmCall._callMojo,PalmCall.cancel=PalmCall._cancelMojo,PalmCall.register=function(){}):EnvironmentUtils.isTriton()?(PalmCall.call=PalmCall._callTriton,PalmCall.cancel=PalmCall._cancelTriton,PalmCall.register=PalmCall._registerTriton): (PalmBus=require("palmbus"),PalmCall.call=PalmCall._callNode,PalmCall.cancel=PalmCall._cancelNode,PalmCall.register=PalmCall._registerNode)}},fs;function loadFileNode(a){return fs.readFileSync(a,"utf8")}function loadFileMojo(a){return palmGetResource(a,!0)}EnvironmentUtils.isNode()?(fs=require("fs"),exports.Comms.loadFile=loadFileNode):exports.Comms.loadFile=loadFileMojo;var Assert=exports.Assert; Assert._templateReplace=function(a,b){if(a&&"function"===typeof a.replace)for(var c in b)if(b.hasOwnProperty(c))for(;;){var d=b[c];void 0===d?d="undefined":null===d&&(d="null");var f=a;a=a.replace("#{"+c+"}",d.toString());if(f===a)break}return a};Assert._throwMsg=function(a,b,c,d){a||(a=b,c=d);a=Assert._templateReplace(a,c);throw Error(a);};Assert._squelchLogs=!1; Assert._logMsg=function(a,b,c,d){a||(a=b,c=d);a=Assert._templateReplace(a,c);Assert._lastLogMsg=a;Assert._squelchLogs||("undefined"!==typeof Mojo?Mojo.Log.error(a):console.error(a))};Assert.require=function(a,b,c){a||Assert._throwMsg(b,"Assert.require failed",c)};Assert.requireFalse=function(a,b,c){a&&Assert._throwMsg(b,"Assert.requireFalse failed",c)};Assert.requireEqual=function(a,b,c,d){a!=b&&Assert._throwMsg(c,"Assert.requireEqual: #{a} != #{b}",d,{a:a,b:b})}; Assert.requireIdentical=function(a,b,c,d){a!==b&&Assert._throwMsg(c,"Assert.requireIdentical: #{a} !== #{b}",d,{a:a,b:b})};Assert.requireArray=function(a,b,c){void 0!==a&&"[object Array]"===Object.prototype.toString.apply(a)||Assert._throwMsg(b,"Assert.requireArray: #{a} is not an Array",c,{a:a})};Assert.requireFunction=function(a,b,c){"function"!==typeof a&&Assert._throwMsg(b,"Assert.requireFunction: #{a} is not a Function",c,{a:a})}; Assert.requireString=function(a,b,c){"string"===typeof a||a&&(a instanceof String||"String"===a.constructor.name)||Assert._throwMsg(b,"Assert.requireString: #{a} is not a String",c,{a:a})};Assert.requireNumber=function(a,b,c){"number"===typeof a||"object"===typeof a&&(a instanceof Number||"Number"===a.constructor.name)||Assert._throwMsg(b,"Assert.requireNumber: #{a} is not a Number",c,{a:a})}; Assert.requireObject=function(a,b,c){"object"===typeof a&&null!==a||Assert._throwMsg(b,"Assert.requireObject: #{a} is not an Object",c,{a:a})};Assert.requireJSONObject=function(a,b,c){var d=Object.prototype.toString.apply(a);(d="[object Array]"!==d&&"[object Object]"!=d)&&Assert._throwMsg(b,"Assert.requireJSONObject: #{a} is not a valid JSON Object",c,{a:a});return!d}; Assert.requireClass=function(a,b,c,d){void 0!==a&&a.constructor===b||Assert._throwMsg(c,'Assert.requireClass: expected "#{a}", was "#{b}"',d,{a:b.name,b:a.constructor.name})};Assert.requireDefined=function(a,b,c){void 0===a&&Assert._throwMsg(b,"Assert.requireDefined: argument undefined",c)};Assert.requireMatch=function(a,b,c,d){a.match(b)||Assert._throwMsg(c,"Assert.requireMatch: no match found",d)}; Assert.requireProperty=function(a,b,c,d){for(var f in b)if(b.hasOwnProperty(f)){var e=b[f];a[f]!==e&&Assert._throwMsg(c,"Assert.requireProperty: obj.#{a} != #{b}",d,{a:f,b:e})}};Assert.requireError=function(a,b,c,d,f,e){try{b.apply(a,c)}catch(g){if(!d||g==d)return;Assert._throwMsg(f,"Assert.requireError: error thrown was '#{a}', instead of '#{e}'",e,{e:d,a:g})}Assert._throwMsg(f,"Assert.requireError: no error thrown",e)}; Assert.assert=function(a,b,c){a||Assert._logMsg(b,"Assert.assert failed",c);return a};Assert.assertFalse=function(a,b,c){a&&Assert._logMsg(b,"Assert.assertFalse failed",c);return!a};Assert.assertEqual=function(a,b,c,d){var f=a!=b;f&&Assert._logMsg(c,"Assert.assertEqual: #{a} != #{b}",d,{a:a,b:b});return!f};Assert.assertIdentical=function(a,b,c,d){var f=a!==b;f&&Assert._logMsg(c,"Assert.assertEqual: #{a} !== #{b}",d,{a:a,b:b});return!f}; Assert.assertArray=function(a,b,c){var d=void 0===a||"[object Array]"!==Object.prototype.toString.apply(a);d&&Assert._logMsg(b,"Assert.assertArray: #{a} is not an Array",c,{a:a});return!d};Assert.assertFunction=function(a,b,c){var d="function"!==typeof a;d&&Assert._logMsg(b,"Assert.assertFunction: #{a} is not a Function",c,{a:a});return!d}; Assert.assertString=function(a,b,c){var d="string"!==typeof a;if(d){if(a&&(a instanceof String||"String"===a.constructor.name))return!0;Assert._logMsg(b,"Assert.assertString: #{a} is not a String",c,{a:a})}return!d};Assert.assertNumber=function(a,b,c){var d="number"!==typeof a;if(d){if("object"===typeof a&&(a instanceof Number||"Number"===a.constructor.name))return!0;Assert._logMsg(b,"Assert.assertNumber: #{a} is not a Number",c,{a:a})}return!d}; Assert.assertObject=function(a,b,c){var d="object"!==typeof a||null===a;d&&Assert._logMsg(b,"Assert.assertObject: #{a} is not an Object",c,{a:a});return!d};Assert.assertClass=function(a,b,c,d){var f=void 0!==a&&a.constructor===b;f||Assert._logMsg(c,'Assert.assertClass: expected "#{a}", was "#{b}"',d,{a:b.name,b:a.constructor.name});return f};Assert.assertDefined=function(a,b,c){(a=void 0!==a)||Assert._logMsg(b,"Assert.assertDefined: argument undefined",c);return a}; Assert.assertMatch=function(a,b,c,d){(a=a.match(b))||Assert._logMsg(c,"Assert.assertMatch: no match found",d);return a};Assert.assertProperty=function(a,b,c,d){for(var f in b)if(b.hasOwnProperty(f)){var e=b[f];if(a[f]!==e)return Assert._logMsg(c,"Assert.assertProperty: obj.#{a} != #{b}",d,{a:f,b:e}),!1}return!0}; Assert.assertError=function(a,b,c,d,f,e){try{b.apply(a,c)}catch(g){if(!d||g==d)return!0;Assert._logMsg(f,"Assert.assertError: error thrown was '#{a}', instead of '#{e}'",e,{e:d,a:g});return!1}Assert._logMsg(f,"Assert.assertError: no error thrown",e);return!1};Assert.assertJSONObject=function(a,b,c){var d=Object.prototype.toString.apply(a);(d="[object Array]"!==d&&"[object Object]"!=d)&&Assert._logMsg(b,"Assert.assertJSONObject: #{a} is not a valid JSON Object",c,{a:a});return!d}; var defaultLocale,create$L=exports.Localization.create$L=function(a,b){var c=readStringTable(b?makeLocale(b):defaultLocale,a+"resources","strings.json");return function(a){return c[a]||a}};function readStringTable(a,b,c){function d(a){try{return JSON.parse(palmGetResource(b+"/"+a+"/"+c))}catch(d){}}var f=d(a.base);if(!f){f=d(a.language)||{};a=d(a.region);for(var e in a)f[e]=a[e]}return f}function makeLocale(a){return{base:a,language:a.slice(0,2),region:a.replace("_","/")}} defaultLocale="undefined"===typeof document||"undefined"===typeof PalmSystem?makeLocale("en_us"):makeLocale(PalmSystem.locale);
-- 
1.8.3.2

